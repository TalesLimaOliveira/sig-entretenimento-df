<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Adicionar Ponto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #map {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .form-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-section h3 {
            margin-top: 0;
            color: #333;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .coord-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-map-marker-plus"></i> Teste - Adicionar Ponto</h1>
        
        <div class="status info">
            <strong>‚ÑπÔ∏è Instru√ß√µes:</strong>
            <br>1. Fa√ßa login como administrador (admin/admin) ou usu√°rio (user/user)
            <br>2. Clique no mapa para selecionar uma localiza√ß√£o
            <br>3. Preencha os dados do ponto
            <br>4. Clique em "Adicionar Ponto"
            <br>5. Verifique se o ponto foi salvo no arquivo correto
        </div>

        <!-- Controles de Autentica√ß√£o -->
        <div class="form-section">
            <h3><i class="fas fa-user-shield"></i> Autentica√ß√£o</h3>
            <button class="btn btn-primary" onclick="testLogin('admin', 'admin')">
                <i class="fas fa-user-shield"></i> Login como Admin
            </button>
            <button class="btn btn-success" onclick="testLogin('user', 'user')">
                <i class="fas fa-user"></i> Login como Usu√°rio
            </button>
            <button class="btn btn-warning" onclick="checkAuthStatus()">
                <i class="fas fa-info-circle"></i> Verificar Status
            </button>
            <button class="btn btn-danger" onclick="testLogout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <div id="auth-status" class="status info" style="margin-top: 10px;">
                Status: N√£o autenticado
            </div>
        </div>

        <!-- Mapa -->
        <div class="form-section">
            <h3><i class="fas fa-map"></i> Selecionar Localiza√ß√£o</h3>
            <div id="map"></div>
            <div id="selected-coords" class="coord-display" style="display: none;">
                <strong>Coordenadas selecionadas:</strong> <span id="coords-text"></span>
            </div>
        </div>

        <!-- Formul√°rio -->
        <div class="form-section">
            <h3><i class="fas fa-edit"></i> Dados do Ponto</h3>
            <form id="point-form">
                <div class="form-group">
                    <label for="point-name">Nome do Local *</label>
                    <input type="text" id="point-name" class="form-input" placeholder="Ex: Restaurante Exemplo" required>
                </div>
                
                <div class="form-group">
                    <label for="point-category">Categoria *</label>
                    <select id="point-category" class="form-select" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="geral">üìç Geral</option>
                        <option value="esportes-lazer">üèÉ Esportes e Lazer</option>
                        <option value="gastronomia">üçΩÔ∏è Gastronomia</option>
                        <option value="geek-nerd">üéÆ Geek</option>
                        <option value="casas-noturnas">üç∏ Casas Noturnas</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="point-description">Descri√ß√£o</label>
                    <textarea id="point-description" class="form-textarea" placeholder="Descreva o local..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="point-address">Endere√ßo</label>
                    <input type="text" id="point-address" class="form-input" placeholder="Rua, n√∫mero, bairro">
                </div>
                
                <div class="form-group">
                    <label for="point-phone">Telefone</label>
                    <input type="tel" id="point-phone" class="form-input" placeholder="(61) 99999-9999">
                </div>
                
                <div class="form-group">
                    <label for="point-price">Pre√ßo</label>
                    <input type="text" id="point-price" class="form-input" placeholder="R$ 10-30 ou Gratuito">
                </div>
                
                <div class="form-group">
                    <label for="point-tags">Tags (separadas por v√≠rgula)</label>
                    <input type="text" id="point-tags" class="form-input" placeholder="Ex: m√∫sica ao vivo, fam√≠lia, pet friendly">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Ponto
                </button>
            </form>
        </div>

        <!-- Resultados -->
        <div id="results">
            <h3><i class="fas fa-list"></i> Resultados</h3>
            <div id="results-content">
                Nenhum teste executado ainda.
            </div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="src/js/auth.js"></script>
    <script src="src/js/database.js"></script>

    <script>
        let map;
        let selectedPosition = null;
        let temporaryMarker = null;

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-15.7935, -47.8828], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(map);
            
            // Click no mapa para selecionar localiza√ß√£o
            map.on('click', function(e) {
                selectedPosition = e.latlng;
                updateLocationDisplay();
                addTemporaryMarker(e.latlng);
                log(`üìç Localiza√ß√£o selecionada: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`);
            });
        }

        function addTemporaryMarker(latlng) {
            if (temporaryMarker) {
                map.removeLayer(temporaryMarker);
            }
            
            temporaryMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'temp-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: red; font-size: 20px;"></i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map);
        }

        function updateLocationDisplay() {
            const coordsDiv = document.getElementById('selected-coords');
            const coordsText = document.getElementById('coords-text');
            
            if (selectedPosition) {
                coordsText.textContent = `${selectedPosition.lat.toFixed(6)}, ${selectedPosition.lng.toFixed(6)}`;
                coordsDiv.style.display = 'block';
            } else {
                coordsDiv.style.display = 'none';
            }
        }

        // Fun√ß√µes de autentica√ß√£o (usando as mesmas do app principal)
        function testLogin(username, password) {
            if (window.authManager) {
                const result = window.authManager.login(username, password);
                updateAuthStatus();
                log(`üîë Login como ${username}: ${result.success ? 'Sucesso' : 'Falha'}`);
                return result;
            } else {
                log('‚ùå AuthManager n√£o dispon√≠vel');
                return { success: false, message: 'AuthManager n√£o dispon√≠vel' };
            }
        }

        function testLogout() {
            if (window.authManager) {
                window.authManager.logout();
                updateAuthStatus();
                log('üö™ Logout realizado');
            } else {
                log('‚ùå AuthManager n√£o dispon√≠vel');
            }
        }

        function checkAuthStatus() {
            if (window.authManager) {
                const user = window.authManager.getCurrentUser();
                const isAuth = window.authManager.isAuthenticated();
                updateAuthStatus();
                log(`üë§ Status: ${isAuth ? 'Autenticado' : 'N√£o autenticado'}`);
                if (user) {
                    log(`üìã Usu√°rio: ${user.username} (${user.role})`);
                }
                return { authenticated: isAuth, user };
            } else {
                log('‚ùå AuthManager n√£o dispon√≠vel');
                return { authenticated: false, user: null };
            }
        }

        function updateAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            if (window.authManager) {
                const user = window.authManager.getCurrentUser();
                const isAuth = window.authManager.isAuthenticated();
                
                if (isAuth && user) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `
                        <strong>‚úÖ Autenticado:</strong> ${user.username} 
                        <span style="background: ${user.role === 'administrator' ? '#ffc107' : '#28a745'}; 
                              color: ${user.role === 'administrator' ? 'black' : 'white'}; 
                              padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                            ${user.role === 'administrator' ? 'üõ°Ô∏è ADMIN' : 'üë§ USER'}
                        </span>
                    `;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '<strong>‚ùå Status:</strong> N√£o autenticado';
                }
            } else {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<strong>‚ùå Status:</strong> AuthManager n√£o dispon√≠vel';
            }
        }

        // Fun√ß√£o para adicionar ponto
        async function addPoint(pointData) {
            try {
                if (!window.databaseManager) {
                    throw new Error('DatabaseManager n√£o dispon√≠vel');
                }

                const user = window.authManager?.getCurrentUser();
                const userRole = user?.role || 'user';
                const username = user?.username || 'anonimo';

                log(`üíæ Tentando adicionar ponto como ${userRole}...`);
                log(`üìä Dados do ponto:`, pointData);

                const novoPonto = window.databaseManager.adicionarPonto(pointData, userRole, username);
                
                log(`‚úÖ Ponto adicionado com sucesso!`);
                log(`üìã ID gerado: ${novoPonto.id}`);
                log(`üìÇ Salvo em: ${userRole === 'administrator' ? 'pontos_confirmados.json' : 'pontos_pendentes.json'}`);
                
                // Mostrar dados salvos
                showDatabaseStatus();
                
                return novoPonto;
            } catch (error) {
                log(`‚ùå Erro ao adicionar ponto: ${error.message}`);
                console.error('Erro detalhado:', error);
                throw error;
            }
        }

        // Mostrar status do banco de dados
        function showDatabaseStatus() {
            if (!window.databaseManager) {
                log('‚ùå DatabaseManager n√£o dispon√≠vel');
                return;
            }

            const stats = window.databaseManager.getEstatisticas();
            log('üìä Status do Banco de Dados:');
            log(`   üìÅ Pontos Confirmados: ${stats.totalConfirmados}`);
            log(`   ‚è≥ Pontos Pendentes: ${stats.totalPendentes}`);
            log(`   üö´ Pontos Ocultos: ${stats.totalOcultos}`);
            log(`   üë• Total de Usu√°rios: ${stats.totalUsuarios}`);
        }

        // Event listener do formul√°rio
        document.getElementById('point-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedPosition) {
                alert('Por favor, selecione uma localiza√ß√£o no mapa');
                return;
            }

            const pointData = {
                nome: document.getElementById('point-name').value.trim(),
                categoria: document.getElementById('point-category').value,
                coordenadas: [selectedPosition.lat, selectedPosition.lng],
                descricao: document.getElementById('point-description').value.trim() || 'Sem descri√ß√£o',
                endereco: document.getElementById('point-address').value.trim() || '',
                telefone: document.getElementById('point-phone').value.trim() || '',
                preco: document.getElementById('point-price').value.trim() || 'N√£o informado',
                tags: document.getElementById('point-tags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag),
                ativo: true,
                dataCriacao: new Date().toISOString()
            };

            if (!pointData.nome || !pointData.categoria) {
                alert('Nome e categoria s√£o obrigat√≥rios');
                return;
            }

            try {
                const novoPonto = await addPoint(pointData);
                
                // Limpar formul√°rio
                document.getElementById('point-form').reset();
                selectedPosition = null;
                updateLocationDisplay();
                if (temporaryMarker) {
                    map.removeLayer(temporaryMarker);
                    temporaryMarker = null;
                }
                
                alert(`Ponto "${pointData.nome}" adicionado com sucesso!\nID: ${novoPonto.id}`);
                
            } catch (error) {
                alert(`Erro ao adicionar ponto: ${error.message}`);
            }
        });

        // Fun√ß√£o de log
        function log(message, data = null) {
            const resultsContent = document.getElementById('results-content');
            const timestamp = new Date().toLocaleTimeString();
            
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += `\n${JSON.stringify(data, null, 2)}`;
            }
            
            const div = document.createElement('div');
            div.style.cssText = 'margin: 5px 0; padding: 5px; background: #f8f9fa; border-left: 3px solid #007bff; font-family: monospace; font-size: 12px; white-space: pre-wrap;';
            div.textContent = logEntry;
            
            resultsContent.appendChild(div);
            resultsContent.scrollTop = resultsContent.scrollHeight;
            
            console.log(message, data || '');
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', function() {
            log('üöÄ Inicializando teste de adicionar ponto...');
            
            // Aguardar um pouco para os scripts carregarem
            setTimeout(() => {
                initMap();
                updateAuthStatus();
                showDatabaseStatus();
                log('‚úÖ Teste inicializado! Pronto para usar.');
            }, 500);
        });
    </script>
</body>
</html>
