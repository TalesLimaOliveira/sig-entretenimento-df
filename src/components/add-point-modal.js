/***ModalparaAdicionarNovosPontos*Interfaceparausu√°riosadicionarempontosaomapa*/classAddPointModal{constructor(){this.modal=null;this.map=null;this.temporaryMarker=null;this.selectedPosition=null;this.init();}init(){this.createModal();this.setupEventListeners();}createModal(){constmodalHTML=`<divid="add-point-modal"class="modal-backdrop"style="display:none;"><divclass="modalmodal-contentlarge"><divclass="modal-header"><h2><iclass="fasfa-map-marker-plus"></i>AdicionarNovoPonto</h2><buttonclass="modal-close"type="button"><iclass="fasfa-times"></i></button></div><divclass="modal-body"><formid="add-point-form"><!--Sele√ß√£odeLocaliza√ß√£o--><divclass="form-section"><h3><iclass="fasfa-map-marker-alt"></i>Localiza√ß√£o</h3><divclass="location-selector"><divclass="location-instructions"><p><iclass="fasfa-info-circle"></i>Cliquenomapaparaselecionaralocaliza√ß√£odoponto</p></div><divclass="selected-coordinates"style="display:none;"><iclass="fasfa-check-circle"></i><span>Localiza√ß√£oselecionada:</span><spanid="coordinates-display"></span><buttontype="button"class="btn-link"id="change-location">Alterar</button></div></div></div><!--Informa√ß√µesB√°sicas--><divclass="form-section"><h3><iclass="fasfa-info-circle"></i>Informa√ß√µesB√°sicas</h3><divclass="form-row"><divclass="form-group"><labelfor="point-name"class="required">NomedoLocal</label><inputtype="text"id="point-name"class="form-input"requiredplaceholder="Digiteonomedolocal"></div><divclass="form-group"><labelfor="point-category"class="required">Categoria</label><selectid="point-category"class="form-select"required><optionvalue="">Selecioneumacategoria</option><optionvalue="cultura">üé≠Cultura</option><optionvalue="gastronomia">üçΩGastronomia</option><optionvalue="noturno">üç∏VidaNoturna</option><optionvalue="esportes">Esportes</option><optionvalue="geral">üìçGeral</option></select></div></div><divclass="form-group"><labelfor="point-description">Descri√ß√£o</label><textareaid="point-description"class="form-textarea"rows="3"placeholder="Descrevaolocal,suascaracter√≠sticasprincipais..."></textarea></div></div><!--DetalhesdoLocal--><divclass="form-section"><h3><iclass="fasfa-building"></i>DetalhesdoLocal</h3><divclass="form-row"><divclass="form-group"><labelfor="point-address">Endere√ßo</label><inputtype="text"id="point-address"class="form-input"placeholder="Rua,n√∫mero,bairro"></div><divclass="form-group"><labelfor="point-phone">Telefone</label><inputtype="tel"id="point-phone"class="form-input"placeholder="(61)99999-9999"></div></div><divclass="form-row"><divclass="form-group"><labelfor="point-website">Website</label><inputtype="url"id="point-website"class="form-input"placeholder="https://exemplo.com"></div><divclass="form-group"><labelfor="point-instagram">Instagram</label><inputtype="text"id="point-instagram"class="form-input"placeholder="@usuario"></div></div></div><!--Hor√°riodeFuncionamento--><divclass="form-section"><h3><iclass="fasfa-clock"></i>Hor√°riodeFuncionamento</h3><divclass="form-group"><labelfor="point-hours">Hor√°rios</label><textareaid="point-hours"class="form-textarea"rows="2"placeholder="Ex:Seg-Sex:10h√†s22h,S√°b-Dom:12h√†s20h"></textarea></div></div><!--Imagem--><divclass="form-section"><h3><iclass="fasfa-image"></i>ImagemdoLocal</h3><divclass="form-row"><divclass="form-group"><labelfor="point-image-source">FontedaImagem</label><selectid="point-image-source"class="form-select"><optionvalue="">Selecioneafonte</option><optionvalue="web">üåêURLdaWeb</option><optionvalue="local">ArquivoLocal</option></select></div><divclass="form-group"><labelfor="point-image-url">URL/CaminhodaImagem</label><inputtype="text"id="point-image-url"class="form-input"placeholder="Selecioneafonteprimeiro"><smallclass="form-help"id="image-help">Selecioneafontedaimagem</small></div></div><divclass="form-group"><labelfor="point-image-description">Descri√ß√£odaImagem</label><inputtype="text"id="point-image-description"class="form-input"placeholder="Brevedescri√ß√£odaimagem(opcional)"></div><divclass="image-preview"id="image-preview"style="display:none;"><imgid="preview-img"src=""alt="Preview"><divclass="image-info"><spanclass="image-source"id="preview-source"></span><buttontype="button"class="btnbtn-smbtn-secondary"id="remove-image"><iclass="fasfa-times"></i>Remover</button></div></div></div><!--Tags--><divclass="form-section"><h3><iclass="fasfa-tags"></i>Tags</h3><divclass="form-group"><labelfor="point-tags">Tags(separadasporv√≠rgula)</label><inputtype="text"id="point-tags"class="form-input"placeholder="Ex:m√∫sicaaovivo,fam√≠lia,petfriendly"><smallclass="form-help">Adicionepalavras-chavequedescrevemolocal</small></div></div></form></div><divclass="modal-footer"><buttontype="button"class="btnbtn-secondary"id="cancel-add-point"><iclass="fasfa-times"></i>Cancelar</button><buttontype="submit"form="add-point-form"class="btnbtn-primary"id="submit-add-point"><iclass="fasfa-plus"></i>AdicionarPonto</button></div></div></div>`;document.body.insertAdjacentHTML('beforeend',modalHTML);this.modal=document.getElementById('add-point-modal');}setupEventListeners(){console.log('Configurandoeventlisteners...');//Formsubmissionconstform=document.getElementById('add-point-form');if(!form){console.error('Formul√°rioadd-point-formn√£oencontrado!');return;}form.addEventListener('submit',(e)=>this.handleSubmit(e));console.log('Eventlistenerdoformul√°rioconfigurado');//ModalcontrolsconstcloseBtn=this.modal.querySelector('.modal-close');constcancelBtn=document.getElementById('cancel-add-point');//Fecharaoclicarnobackdrop(foradomodal)this.modal.addEventListener('click',(e)=>{if(e.target===this.modal){console.log('üö™Fechandomodalviabackdrop');this.close();}});//Bot√µesdefechar[closeBtn,cancelBtn].forEach((element,index)=>{if(element){element.addEventListener('click',()=>{console.log(`üö™Fechandomodalviabot√£o${index===0?'close':'cancel'}`);this.close();});console.log(`Eventlistenerconfiguradoparabot√£o${index===0?'close':'cancel'}`);}else{console.warn(`Bot√£o${index===0?'close':'cancel'}n√£oencontrado`);}});//ImagesystemeventlistenersconstimageSource=document.getElementById('point-image-source');constimageUrl=document.getElementById('point-image-url');constimageHelp=document.getElementById('image-help');constremoveImageBtn=document.getElementById('remove-image');if(imageSource){imageSource.addEventListener('change',(e)=>this.handleImageSourceChange(e.target.value));console.log('Eventlistenerparafontedeimagemconfigurado');}if(imageUrl){imageUrl.addEventListener('input',(e)=>this.handleImageUrlInput(e.target.value));console.log('EventlistenerparaURLdeimagemconfigurado');}if(removeImageBtn){removeImageBtn.addEventListener('click',()=>this.removeImagePreview());console.log('Eventlistenerpararemoverimagemconfigurado');}//LegacyimagepreviewsupportconstlegacyImageInput=document.getElementById('point-image');if(legacyImageInput){legacyImageInput.addEventListener('input',(e)=>this.previewImage(e.target.value));console.log('Eventlistenerparapreviewdeimagem(legado)configurado');}//ChangelocationbuttonconstchangeLocationBtn=document.getElementById('change-location');if(changeLocationBtn){changeLocationBtn.addEventListener('click',()=>this.enableLocationSelection());console.log('Eventlistenerparamudan√ßadelocaliza√ß√£oconfigurado');}//ESCkeydocument.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.isVisible()){console.log('üö™FechandomodalviaESC');this.close();}});console.log('Todososeventlistenersconfigurados!');}open(options={}){if(!this.modal)return;//Configurarmodobaseadonasop√ß√µesthis.isEditMode=options.isEditMode||false;this.isSuggestion=options.isSuggestion||false;this.originalPoint=options.originalPoint||null;this.onSaveCallback=options.onSave||null;//Resetformthis.resetForm();//Configurart√≠tulobaseadonomodothis.updateModalTitle();//Atualizartextodobot√£othis.updateSubmitButton();//Pr√©-preencherdadossefornecidosif(options.pointData){this.fillFormData(options.pointData);}//Showmodalthis.modal.style.display='block';document.body.classList.add('modal-open');//Getmapreferencethis.map=window.mapManager?.map;//Enablelocationselectionapenassen√£oformododesugest√£oif(!this.isSuggestion){this.enableLocationSelection();}else{//Parasugest√µes,j√°temosalocaliza√ß√£oif(options.pointData&&options.pointData.coordenadas){this.selectedPosition=options.pointData.coordenadas;this.showSelectedCoordinates(options.pointData.coordenadas);}}//FocusfirstinputsetTimeout(()=>{constfirstInput=this.modal.querySelector('input[type="text"]');if(firstInput)firstInput.focus();},100);}/***Atualizart√≠tulodomodalbaseadonomodo*/updateModalTitle(){consttitleElement=this.modal.querySelector('.modal-headerh2');if(!titleElement)return;if(this.isSuggestion){titleElement.innerHTML='<iclass="fasfa-edit"></i>SugerirAltera√ß√µes';}elseif(this.isEditMode){titleElement.innerHTML='<iclass="fasfa-edit"></i>EditarPonto';}else{titleElement.innerHTML='<iclass="fasfa-map-marker-plus"></i>AdicionarNovoPonto';}}/***Atualizartextodobot√£odesubmitbaseadonomodo*/updateSubmitButton(){constsubmitBtn=document.getElementById('submit-add-point');if(!submitBtn)return;if(this.isSuggestion){submitBtn.innerHTML='<iclass="fasfa-paper-plane"></i>EnviarSugest√£o';}elseif(this.isEditMode){submitBtn.innerHTML='<iclass="fasfa-save"></i>SalvarAltera√ß√µes';}else{submitBtn.innerHTML='<iclass="fasfa-plus"></i>AdicionarPonto';}}/***Preencherformul√°riocomdadosfornecidos*/fillFormData(data){//Preenchercamposb√°sicosthis.setFieldValue('point-name',data.nome);this.setFieldValue('point-category',data.categoria);this.setFieldValue('point-description',data.descricao);this.setFieldValue('point-address',data.endereco);this.setFieldValue('point-phone',data.telefone);this.setFieldValue('point-website',data.website);this.setFieldValue('point-hours',data.horario);this.setFieldValue('point-price',data.preco);this.setFieldValue('point-image',data.imagem);//Setemcoordenadas,marcarcomoselecionadasif(data.coordenadas&&Array.isArray(data.coordenadas)){this.selectedPosition=data.coordenadas;this.showSelectedCoordinates(data.coordenadas);}}/***Definirvalordeumcampodoformul√°rio*/setFieldValue(fieldId,value){constfield=document.getElementById(fieldId);if(field&&value!==undefined&&value!==null){field.value=value;}}/***Mostrarcoordenadasselecionadas*/showSelectedCoordinates(coords){constcoordsDisplay=document.getElementById('coordinates-display');constcoordsContainer=document.querySelector('.selected-coordinates');constinstructionsContainer=document.querySelector('.location-instructions');if(coordsDisplay&&coordsContainer&&instructionsContainer){coordsDisplay.textContent=`${coords[0].toFixed(6)},${coords[1].toFixed(6)}`;coordsContainer.style.display='block';instructionsContainer.style.display='none';}}close(){if(!this.modal)return;this.modal.style.display='none';document.body.classList.remove('modal-open');//Cleanupmapinteractionthis.disableLocationSelection();this.clearTemporaryMarker();}isVisible(){returnthis.modal&&this.modal.style.display==='block';}resetForm(){constform=document.getElementById('add-point-form');form.reset();this.selectedPosition=null;this.updateLocationDisplay();this.clearImagePreview();}enableLocationSelection(){if(!this.map)return;this.showLocationInstructions();//Addclickhandlertomapthis.map.on('click',this.onMapClick.bind(this));this.map.getContainer().style.cursor='crosshair';}disableLocationSelection(){if(!this.map)return;this.map.off('click',this.onMapClick.bind(this));this.map.getContainer().style.cursor='';}onMapClick(e){this.selectedPosition=e.latlng;this.updateLocationDisplay();this.addTemporaryMarker(e.latlng);this.disableLocationSelection();}addTemporaryMarker(latlng){this.clearTemporaryMarker();if(this.map){this.temporaryMarker=L.marker(latlng,{icon:L.divIcon({className:'temporary-marker',html:'<iclass="fasfa-map-marker-alt"></i>',iconSize:[30,30],iconAnchor:[15,30]})}).addTo(this.map);}}clearTemporaryMarker(){if(this.temporaryMarker&&this.map){this.map.removeLayer(this.temporaryMarker);this.temporaryMarker=null;}}updateLocationDisplay(){constinstructions=document.querySelector('.location-instructions');constcoordinates=document.querySelector('.selected-coordinates');constcoordsDisplay=document.getElementById('coordinates-display');if(this.selectedPosition){instructions.style.display='none';coordinates.style.display='flex';coordsDisplay.textContent=`${this.selectedPosition.lat.toFixed(6)},${this.selectedPosition.lng.toFixed(6)}`;}else{instructions.style.display='block';coordinates.style.display='none';}}showLocationInstructions(){constinstructions=document.querySelector('.location-instructions');constcoordinates=document.querySelector('.selected-coordinates');instructions.style.display='block';coordinates.style.display='none';}previewImage(url){constpreview=document.getElementById('image-preview');constimg=document.getElementById('preview-img');if(url&&this.isValidImageUrl(url)){img.src=url;preview.style.display='block';}else{this.clearImagePreview();}}clearImagePreview(){constpreview=document.getElementById('image-preview');preview.style.display='none';}isValidImageUrl(url){try{newURL(url);return/\.(jpg|jpeg|png|gif|webp)$/i.test(url);}catch{returnfalse;}}/***Manipulamudan√ßanafontedaimagem*/handleImageSourceChange(source){constimageUrl=document.getElementById('point-image-url');constimageHelp=document.getElementById('image-help');if(!imageUrl||!imageHelp)return;switch(source){case'web':imageUrl.placeholder='https://exemplo.com/imagem.jpg';imageUrl.type='url';imageHelp.textContent='Coleaquiolinkdeumaimagemdaweb(http/https)';imageUrl.disabled=false;break;case'local':imageUrl.placeholder='/assets/images/minha-imagem.jpg';imageUrl.type='text';imageHelp.textContent='Digiteocaminhoparaoarquivonoservidor(ex:/assets/images/...)';imageUrl.disabled=false;break;default:imageUrl.placeholder='Selecioneafonteprimeiro';imageUrl.type='text';imageHelp.textContent='Selecioneafontedaimagem';imageUrl.disabled=true;imageUrl.value='';this.clearImagePreview();break;}}/***ManipulaentradadaURL/caminhodaimagem*/handleImageUrlInput(url){constsource=document.getElementById('point-image-source').value;if(!source||!url.trim()){this.clearImagePreview();return;}//ValidarURLbaseadanafonteletisValid=false;if(source==='web'){isValid=this.isValidWebImageUrl(url);}elseif(source==='local'){isValid=this.isValidLocalImagePath(url);}if(isValid){this.previewImageWithSource(url,source);}else{this.clearImagePreview();}}/***ValidaURLdeimagemdaweb*/isValidWebImageUrl(url){try{constparsedUrl=newURL(url);return(parsedUrl.protocol==='http:'||parsedUrl.protocol==='https:')&&/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(url);}catch{returnfalse;}}/***Validacaminhodeimagemlocal*/isValidLocalImagePath(path){//Verificarse√©umcaminhov√°lidoetemextens√£odeimagemreturnpath.startsWith('/')||path.startsWith('./')||path.startsWith('../')||path.startsWith('assets/')&&/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(path);}/***Previewdeimagemcominforma√ß√£odafonte*/previewImageWithSource(url,source){constpreview=document.getElementById('image-preview');constimg=document.getElementById('preview-img');constsourceSpan=document.getElementById('preview-source');if(img&&preview&&sourceSpan){img.src=url;img.alt=`Previewdaimagem`;constsourceIcon=source==='web'?'üåê':'';constsourceText=source==='web'?'Web':'Local';sourceSpan.innerHTML=`${sourceIcon}${sourceText}`;preview.style.display='block';//Tratamentodeerrodecarregamentoimg.onerror=()=>{console.warn(`Erroaocarregarimagem:${url}`);this.clearImagePreview();};}}/***Removepreviewdaimagem*/removeImagePreview(){document.getElementById('point-image-source').value='';document.getElementById('point-image-url').value='';document.getElementById('point-image-description').value='';this.handleImageSourceChange('');//Resetdoscamposthis.clearImagePreview();}asynchandleSubmit(e){e.preventDefault();console.log('üöÄIniciandosubmiss√£odoformul√°rio...');if(!this.validateForm()){console.error('Valida√ß√£odoformul√°riofalhou');return;}console.log('Formul√°riovalidadocomsucesso');constpointData=this.collectFormData();console.log('Dadoscoletados:',pointData);try{constsubmitBtn=document.getElementById('submit-add-point');if(!submitBtn){thrownewError('Bot√£odesubmitn√£oencontrado');}submitBtn.disabled=true;if(this.isSuggestion){submitBtn.innerHTML='<iclass="fasfa-spinnerfa-spin"></i>EnviandoSugest√£o...';//Parasugest√µes,chamarcallbackpersonalizadoif(this.onSaveCallback){this.onSaveCallback(pointData);this.showSuccess('Sugest√£oenviadacomsucesso!');this.close();}else{thrownewError('Callbackdesalvamenton√£odefinidoparasugest√£o');}}else{submitBtn.innerHTML='<iclass="fasfa-spinnerfa-spin"></i>Adicionando...';console.log('Tentandosalvarponto...');awaitthis.submitPoint(pointData);console.log('Pontosalvocomsucesso');this.showSuccess('Pontoadicionadocomsucesso!');this.close();//Refreshmapifavailableif(window.mapManager){console.log('Recarregandomapa...');setTimeout(()=>window.mapManager.carregarPontos(),500);}}}catch(error){console.error('üí•Erroaoprocessarformul√°rio:',error);console.error('Stacktrace:',error.stack);consterrorMessage=this.isSuggestion?'Erroaoenviarsugest√£o.Tentenovamente.':'Erroaoadicionarponto.Tentenovamente.';this.showError(errorMessage+`(${error.message})`);}finally{constsubmitBtn=document.getElementById('submit-add-point');if(submitBtn){submitBtn.disabled=false;//Restaurartextodobot√£obaseadonomodoif(this.isSuggestion){submitBtn.innerHTML='<iclass="fasfa-paper-plane"></i>EnviarSugest√£o';}else{submitBtn.innerHTML='<iclass="fasfa-plus"></i>AdicionarPonto';}}}}validateForm(){console.log('Validandoformul√°rio...');if(!this.selectedPosition){console.error('Localiza√ß√£on√£oselecionada');this.showError('Porfavor,selecioneumalocaliza√ß√£onomapa');returnfalse;}console.log('Localiza√ß√£ov√°lida:',this.selectedPosition);constrequired=['point-name','point-category'];for(constfieldIdofrequired){constfield=document.getElementById(fieldId);if(!field){console.error(`Campo${fieldId}n√£oencontradonoDOM`);this.showError(`Errointerno:Campo${fieldId}n√£oencontrado`);returnfalse;}if(!field.value.trim()){console.error(`Campoobrigat√≥riovazio:${fieldId}`);field.focus();constlabel=field.previousElementSibling?.textContent||fieldId;this.showError(`Campoobrigat√≥rio:${label}`);returnfalse;}console.log(`Campo${fieldId}v√°lido:`,field.value.trim());}console.log('Formul√°riov√°lido!');returntrue;}collectFormData(){constuser=window.authManager?.getCurrentUser();//ColetardadosdaimagemconstimageSource=document.getElementById('point-image-source')?.value;constimageUrl=document.getElementById('point-image-url')?.value?.trim();constimageDescription=document.getElementById('point-image-description')?.value?.trim();//Criarobjetodeimagemseh√°dadossuficientesletimageData=null;if(imageSource&&imageUrl){imageData={url:imageUrl,source:imageSource,description:imageDescription||null,addedAt:newDate().toISOString()};}//Suportelegadoparacampopoint-image(seexistir)constlegacyImage=document.getElementById('point-image')?.value?.trim();if(!imageData&&legacyImage){imageData={url:legacyImage,source:'web',//Assumirwebparacompatibilidadedescription:null,addedAt:newDate().toISOString()};}return{nome:document.getElementById('point-name').value.trim(),categoria:document.getElementById('point-category').value,descricao:document.getElementById('point-description').value.trim(),endereco:document.getElementById('point-address').value.trim(),telefone:document.getElementById('point-phone').value.trim(),website:document.getElementById('point-website').value.trim(),instagram:document.getElementById('point-instagram').value.trim(),horario:document.getElementById('point-hours').value.trim(),imagem:imageData,//Novaestruturadeimagemtags:document.getElementById('point-tags').value.split(',').map(tag=>tag.trim()).filter(tag=>tag),coordenadas:[this.selectedPosition.lat,this.selectedPosition.lng],latitude:this.selectedPosition.lat,longitude:this.selectedPosition.lng,nota:0,verificado:user?.role==='administrator',adicionadoPor:user?.username||user?.name||'Usu√°rioAn√¥nimo'};}asyncsubmitPoint(pointData){if(!window.databaseManager?.adicionarPonto){thrownewError('Databasemanagern√£odispon√≠vel');}constuser=window.authManager?.getCurrentUser();constuserRole=user?.role||'visitor';constusername=user?.username||null;constnovoPonto=window.databaseManager.adicionarPonto(pointData,userRole,username);//Adicionaraomapaseforadministrador(pontosaprovadosautomaticamente)if(userRole==='administrator'&&window.mapManager?.adicionarMarcador){window.mapManager.adicionarMarcador(novoPonto);}returnnovoPonto;}showSuccess(message){if(window.infoPanelManager?.showNotification){window.infoPanelManager.showNotification(message,'success');}else{alert(message);}}showError(message){if(window.infoPanelManager?.showNotification){window.infoPanelManager.showNotification(message,'error');}else{alert(message);}}}//Inicializarglobalmentewindow.addPointModal=newAddPointModal();