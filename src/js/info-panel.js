/***GerenciadordoPainelLateraldeInformações-CleanArchitecture**Responsabilidades:*-Exibirinformaçõesdospontosselecionados*-Controlarabertura/fechamentodopainel*-Renderizarconteúdodeformaestruturada*-Gerenciareventosdeinteração**@authorTalesOliveira(github.com/TalesLimaOliveira)*@version1.0.0*@noteEstearquivocontémtrechosdecódigogeradoscomauxíliodeInteligênciaArtificial.*/classInfoPanelManager{constructor(){this.panel=null;this.panelBody=null;this.panelTitle=null;this.panelImage=null;this.imagePlaceholder=null;this.closeButton=null;this.tabs=null;this.tabContents=null;this.currentTab='overview';this.isVisible=false;this.currentPoint=null;this.init();}/***Inicializaogerenciadordopainel*/init(){console.log('InicializandoInfoPanelManager...');this.setupElements();this.setupEventListeners();console.log('InfoPanelManagerinicializado');}/***ConfigurarelementosDOM*/setupElements(){this.panel=document.getElementById('info-panel');this.panelBody=document.getElementById('info-panel-body');this.panelTitle=document.getElementById('info-panel-title');this.panelImage=document.getElementById('info-panel-image');this.imagePlaceholder=document.querySelector('.info-panel-image-placeholder');this.closeButton=document.getElementById('info-panel-close');this.tabs=document.querySelectorAll('.info-panel-tab');this.tabContents=document.querySelectorAll('.info-panel-tab-content');if(!this.panel||!this.panelBody||!this.panelTitle||!this.closeButton){console.error('Elementosdopainelnãoencontrados');return;}}/***Configurareventlisteners*/setupEventListeners(){if(!this.closeButton)return;//Botãodefecharthis.closeButton.addEventListener('click',()=>{this.hide();});//Eventosdasabasthis.tabs.forEach(tab=>{tab.addEventListener('click',()=>{consttabName=tab.getAttribute('data-tab');this.switchTab(tabName);});});//FecharcomteclaESCdocument.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.isVisible){//NãofecharsehouvermodalabertoconsthasOpenModal=document.querySelector('.modal-backdrop[style*="flex"]')||document.querySelector('.modal-backdrop[style*="block"]');if(!hasOpenModal){this.hide();}}});//Fecharaoclicarforadopainel(nomapa)document.addEventListener('click',(e)=>{if(this.isVisible&&!this.panel.contains(e.target)&&!e.target.closest('.marcador-otimizado')&&!e.target.closest('.modal-backdrop')&&!e.target.closest('.login-modal')&&!e.target.closest('.leaflet-popup')&&!e.target.closest('.leaflet-marker-icon')&&!e.target.closest('.custom-marker')){//AdicionardelayparaevitarfechamentoimediatodurantecliquesemmarcadoressetTimeout(()=>{if(this.isVisible){this.hide();}},100);}});}/***Alternarentreabas*@param{string}tabName-Nomedaaba*/switchTab(tabName){//Atualizarestadodaabaatualthis.currentTab=tabName;//Removerclasseactivedetodasasabaseconteúdosthis.tabs.forEach(tab=>tab.classList.remove('active'));this.tabContents.forEach(content=>content.classList.remove('active'));//AdicionarclasseactivenaabaeconteúdoselecionadosconstactiveTab=document.querySelector(`[data-tab="${tabName}"]`);constactiveContent=document.getElementById(`tab-${tabName}`);if(activeTab)activeTab.classList.add('active');if(activeContent)activeContent.classList.add('active');console.log(`Abaalteradapara:${tabName}`);}/***Exibirpainelcominformaçõesdoponto*@param{Object}ponto-Dadosdoponto*/show(ponto){if(!this.panel||!ponto)return;//EvitarqueeventosdecliqueinterfiramduranteaaberturaconstpreventClick=(e)=>{e.stopPropagation();e.preventDefault();};//Adicionarlistenertemporárioparaprevenirinterferênciadocument.addEventListener('click',preventClick,{once:true,capture:true});this.currentPoint=ponto;this.renderContent(ponto);this.setupImage(ponto);//GarantirqueaabaOverviewestáselecionadathis.switchTab('overview');//Adicionarclasseaobodyparaajustarlayoutdocument.body.classList.add('body-with-info-panel');//Mostrarpainelcomtransiçãosuavethis.panel.classList.remove('hidden');//UsarrequestAnimationFrameparagarantirqueatransiçãoocorrarequestAnimationFrame(()=>{this.panel.classList.add('visible');});this.isVisible=true;console.log('Painelabertopara:',ponto.nome);//RemoverolistenerpreventivoapósumbrevedelaysetTimeout(()=>{document.removeEventListener('click',preventClick,{capture:true});},200);}/***Ocultarpainel*/hide(){if(!this.panel||!this.isVisible)return;this.panel.classList.remove('visible');setTimeout(()=>{this.panel.classList.add('hidden');},300);//Removerclassedobodydocument.body.classList.remove('body-with-info-panel');this.isVisible=false;this.currentPoint=null;console.log('Painelfechado');}/***Configurarimagemdopainel*@param{Object}ponto-Dadosdoponto*/setupImage(ponto){if(!this.panelImage||!this.imagePlaceholder)return;//Definirtítulodaimagemthis.panelTitle.textContent=ponto.nome||'Localselecionado';//Verificarseháimagemdisponível(novaestruturaoulegada)letimageUrl=null;letimageDescription='';if(ponto.imagem){if(typeofponto.imagem==='object'&&ponto.imagem.url){//NovaestruturacomobjetodeimagemimageUrl=ponto.imagem.url;imageDescription=ponto.imagem.description||`Imagemde${ponto.nome}`;}elseif(typeofponto.imagem==='string'&&ponto.imagem!=='https://via.placeholder.com/300x200'){//EstruturalegadacomstringimageUrl=ponto.imagem;imageDescription=`Imagemde${ponto.nome}`;}}if(imageUrl){this.panelImage.src=imageUrl;this.panelImage.alt=imageDescription;this.panelImage.title=imageDescription;this.panelImage.style.display='block';this.imagePlaceholder.style.display='none';//Tratamentodeerrodecarregamentodaimagemthis.panelImage.onerror=()=>{console.warn(`Erroaocarregarimagem:${imageUrl}`);this.panelImage.style.display='none';this.imagePlaceholder.style.display='flex';};}else{//Mostrarplaceholderquandonãoháimagemthis.panelImage.style.display='none';this.imagePlaceholder.style.display='flex';}}/***Renderizarconteúdodopainel*@param{Object}ponto-Dadosdoponto*/renderContent(ponto){if(!this.panelBody)return;constcategoria=window.databaseManager?.obterCategoria(ponto.categoria);constisAdmin=window.authManager?.isAdmin();constuser=window.authManager?.getCurrentUser();//RenderizarapenasoconteúdodaabaOverviewthis.panelBody.innerHTML=`<divclass="info-details">${this.renderBasicInfo(ponto)}${this.renderContactInfo(ponto)}${this.renderAdditionalInfo(ponto)}${this.renderTags(ponto)}${this.renderUserActions(ponto,user)}${isAdmin?this.renderAdminActions(ponto):''}</div>`;//Configurareventosdosbotõesthis.setupActionButtons(ponto,user);if(isAdmin){this.setupAdminButtons(ponto);}}/***Renderizaraçõesdousuário(favoritar,sugerirmudança)*/renderUserActions(ponto,user){if(!ponto)return'';constisAuthenticated=window.authManager?.isAuthenticated();//!TODO:Implementarsistemadefavoritos//constisFavorito=isAuthenticated&&user?//window.databaseManager?.isFavorito(ponto.id,user.username):false;constisFavorito=false;//Temporariamentesemprefalsereturn`<divclass="info-user-actions"><divclass="action-buttons-top"><buttonclass="action-btnfavorite-btn"id="btn-favorite"data-ponto-id="${ponto.id}"title="Funcionalidadeemdesenvolvimento"><iclass="fasfa-heart"></i>Favoritar</button><buttonclass="action-btnroutes-btn"id="btn-routes"data-ponto-id="${ponto.id}"disabled><iclass="fasfa-route"></i>Rotas</button></div><divclass="action-buttons-bottom"><buttonclass="action-btnsuggest-btn"id="btn-suggest"data-ponto-id="${ponto.id}"><iclass="fasfa-edit"></i>Sugerirmudança</button></div></div>`;}/***Configurareventosdosbotõesdeação*/setupActionButtons(ponto,user){//BotãodefavoritarconstfavoriteBtn=document.getElementById('btn-favorite');if(favoriteBtn){favoriteBtn.addEventListener('click',(e)=>{e.preventDefault();this.handleFavoriteClick(ponto);});}//Botãoderotas(nãofuncional)constroutesBtn=document.getElementById('btn-routes');if(routesBtn){routesBtn.addEventListener('click',(e)=>{e.preventDefault();this.showNotification('Funcionalidadederotasemdesenvolvimento','info');});}//BotãodesugerirmudançaconstsuggestBtn=document.getElementById('btn-suggest');if(suggestBtn){suggestBtn.addEventListener('click',(e)=>{e.preventDefault();this.handleSuggestClick(ponto);});}}/***Handlecliquenobotãodefavoritar*/handleFavoriteClick(ponto){//!TODO:Implementarsistemadefavoritosconsole.log('!TODO:Implementarsistemadefavoritos');//Mostrarnotificaçãodedesenvolvimentothis.showNotification('Emdesenvolvimento','info');return;}/***Handlecliquenobotãodesugerirmudança*/handleSuggestClick(ponto){//Verificaçãoseguradeautenticaçãoif(!window.authManager||!window.authManager.isAuthenticated()){console.log('InfoPanel:Usuárionãoautenticado-abrindomodaldelogin');if(!window.loginModal){console.error('InfoPanel:Modaldeloginnãodisponível');this.showNotification('Sistemadeloginnãodisponível.Recarregueapágina.','error');return;}window.loginModal.open({pendingAction:()=>this.handleSuggestClick(ponto)});return;}//Abrirmodaldeformuláriocomdadospré-preenchidosthis.openSuggestionFormModal(ponto);}/***Abrirmodaldeformuláriocomdadospré-preenchidosparasugestão*/openSuggestionFormModal(ponto){try{//Verificarseomodaldeadicionarpontoexisteif(!window.addPointModal){console.error('Modaldeadicionarpontonãoencontrado');this.showNotification('Erro:Modalnãodisponível','error');return;}//Abriromodalcomosdadosdopontoatualwindow.addPointModal.open({isEditMode:true,isSuggestion:true,pointData:{id:ponto.id,nome:ponto.nome||'',categoria:ponto.categoria||'geral',descricao:ponto.descricao||'',endereco:ponto.endereco||'',telefone:ponto.telefone||'',website:ponto.website||'',horario:ponto.horario||'',preco:ponto.preco||'',imagem:ponto.imagem||'',coordenadas:ponto.coordenadas||[ponto.lat,ponto.lng]},originalPoint:ponto,onSave:(dadosAtualizados)=>{this.processarSugestao(ponto,dadosAtualizados);}});console.log('Modaldesugestãoabertopara:',ponto.nome);}catch(error){console.error('Erroaoabrirmodaldesugestão:',error);this.showNotification('Erroaoabrirformuláriodesugestão','error');}}/***Processarsugestãoenviadapeloformulário*/processarSugestao(pontoOriginal,dadosAtualizados){try{constuser=window.authManager.getCurrentUser();if(!user){this.showNotification('Erro:Usuárionãoautenticado','error');return;}//Identificarquaiscamposforamalteradosconstsugestoes={};constcamposParaComparar=['nome','categoria','descricao','endereco','telefone','website','horario','preco','imagem'];for(constcampoofcamposParaComparar){constvalorOriginal=pontoOriginal[campo]||'';constvalorNovo=dadosAtualizados[campo]||'';if(valorNovo!==valorOriginal&&valorNovo.trim()!==''){sugestoes[campo]=valorNovo.trim();}}//Verificarcoordenadasif(dadosAtualizados.coordenadas&&(dadosAtualizados.coordenadas[0]!==pontoOriginal.lat||dadosAtualizados.coordenadas[1]!==pontoOriginal.lng)){sugestoes.coordenadas=dadosAtualizados.coordenadas;}//Verificarseháalgumasugestãoif(Object.keys(sugestoes).length===0){this.showNotification('Nenhumaalteraçãodetectada','info');return;}//Enviarsugestãowindow.databaseManager.sugerirMudanca(pontoOriginal.id,sugestoes,user.username);this.showNotification('Sugestãoenviadaparaanálise!','success');console.log('Sugestãoprocessada:',sugestoes);}catch(error){console.error('Erroaoprocessarsugestão:',error);this.showNotification('Erroaoenviarsugestão','error');}}/***Mostrarnotificação*/showNotification(message,type='info'){//Sistemadethrottlingparareduzirnotificaçõesrepetidasif(!this.notificationThrottle){this.notificationThrottle=newMap();}constthrottleKey=`${type}-${message}`;constnow=Date.now();constlastShown=this.notificationThrottle.get(throttleKey);//Paraerros,sómostrarsepassoupelomenos5segundos//Paraoutrostipos,2segundosconstthrottleTime=type==='error'?5000:2000;if(lastShown&&(now-lastShown)<throttleTime){console.log(`Notificaçãothrottled:${message}`);return;}this.notificationThrottle.set(throttleKey,now);//Usarosistemadenotificaçõesglobalsedisponívelif(window.notificationSystem){window.notificationSystem.show(message,type);return;}//Fallbackparaimplementaçãosimplesthis.showSimpleNotification(message,type);}/***Implementaçãosimplesdenotificaçãocomofallback*/showSimpleNotification(message,type){//LimitarnúmerodenotificaçõessimultâneasconstexistingNotifications=document.querySelectorAll('.notification.show');if(existingNotifications.length>=3){//Removeramaisantigaconstoldest=existingNotifications[0];oldest.style.transform='translateX(100%)';setTimeout(()=>{if(oldest.parentNode){oldest.parentNode.removeChild(oldest);}},300);}constcolors={success:'#10b981',error:'#ef4444',info:'#3b82f6',warning:'#f59e0b'};constnotification=document.createElement('div');notification.className=`notification${type}show`;notification.innerHTML=`<divstyle="display:flex;align-items:center;gap:0.5rem;"><iclass="fasfa-${this.getNotificationIcon(type)}"></i><span>${message}</span></div>`;//ReduzirtamanhodasnotificaçõesdeerroconstfontSize=type==='error'?'0.85rem':'0.9rem';constpadding=type==='error'?'0.75rem':'1rem';notification.style.cssText=`position:fixed;top:${20+(existingNotifications.length*70)}px;right:20px;background:${colors[type]||colors.info};color:white;padding:${padding};border-radius:6px;z-index:10001;max-width:280px;font-size:${fontSize};transform:translateX(100%);transition:transform0.3sease;box-shadow:04px12pxrgba(0,0,0,0.15);`;document.body.appendChild(notification);//MostrarnotificaçãorequestAnimationFrame(()=>{notification.style.transform='translateX(0)';});//Tempobaseadonotipo:errosdurammenosconstduration=type==='error'?3000:4000;//RemoverapósotempoespecificadosetTimeout(()=>{notification.style.transform='translateX(100%)';setTimeout(()=>{if(notification.parentNode){document.body.removeChild(notification);}},300);},duration);}/***Obteríconeparanotificação*/getNotificationIcon(type){consticons={success:'check-circle',error:'exclamation-circle',info:'info-circle',warning:'exclamation-triangle'};returnicons[type]||icons.info;}/***Renderizarinformaçõesbásicas*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinformaçõesbásicas*/renderBasicInfo(ponto){lethtml='';if(ponto.endereco){html+=`<divclass="info-detail"><spanclass="info-detail-icon">📍</span><spanclass="info-detail-text">${ponto.endereco}</span></div>`;}if(ponto.descricao){html+=`<divclass="info-detail"><spanclass="info-detail-icon">📝</span><spanclass="info-detail-text">${ponto.descricao}</span></div>`;}returnhtml;}/***Renderizarinformaçõesdecontato*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinformaçõesdecontato*/renderContactInfo(ponto){lethtml='';if(ponto.telefone){html+=`<divclass="info-detail"><spanclass="info-detail-icon">📞</span><spanclass="info-detail-text"><ahref="tel:${ponto.telefone}"class="info-link">${ponto.telefone}</a></span></div>`;}if(ponto.website){html+=`<divclass="info-detail"><spanclass="info-detail-icon">🌐</span><spanclass="info-detail-text"><ahref="${ponto.website}"target="_blank"class="info-link">Siteoficial</a></span></div>`;}returnhtml;}/***Renderizarinformaçõesadicionais*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinformaçõesadicionais*/renderAdditionalInfo(ponto){lethtml='';if(ponto.horario){html+=`<divclass="info-detail"><spanclass="info-detail-icon">🕒</span><spanclass="info-detail-text">${ponto.horario}</span></div>`;}if(ponto.preco){html+=`<divclass="info-detail"><spanclass="info-detail-icon">💰</span><spanclass="info-detail-text">${ponto.preco}</span></div>`;}if(ponto.avaliacao>0){html+=`<divclass="info-detail"><spanclass="info-detail-icon"></span><spanclass="info-detail-text">${ponto.avaliacao}/5</span></div>`;}returnhtml;}/***Renderizartags*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdastags*/renderTags(ponto){if(!ponto.tags||!Array.isArray(ponto.tags)||ponto.tags.length===0){return'';}consttagsHtml=ponto.tags.map(tag=>`<spanclass="info-tag">#${tag}</span>`).join('');return`<divclass="info-tags">${tagsHtml}</div>`;}/***Renderizaraçõesdeadministrador*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasaçõesdeadmin*/renderAdminActions(ponto){return`<divclass="info-admin-actions"><buttonclass="info-admin-btnedit"data-action="edit"data-id="${ponto.id}"><iclass="fasfa-edit"></i>Editar</button><buttonclass="info-admin-btndelete"data-action="delete"data-id="${ponto.id}"><iclass="fasfa-trash"></i>Remover</button></div>`;}/***Obteríconedacategoria*@param{Object}categoria-Dadosdacategoria*@returns{string}Emojidoícone*/getIconeCategoria(categoria){if(!categoria)return'📍';constmapaIcones={'cultura':'🎭','gastronomia':'🍴','noturno':'🍺','esportes':'','geral':'📍','teatro':'🎭','museu':'🏛','parque':'🌳','restaurante':'🍽','bar':'🍻','clube':'🎵','academia':'🏋','shopping':'🛍'};returnmapaIcones[categoria.id]||mapaIcones[categoria.nome?.toLowerCase()]||'📍';}/***Configurarbotõesdeadministrador*@param{Object}ponto-Dadosdoponto*/setupAdminButtons(ponto){consteditBtn=this.panelBody.querySelector('[data-action="edit"]');constdeleteBtn=this.panelBody.querySelector('[data-action="delete"]');if(editBtn){editBtn.addEventListener('click',()=>{this.handleEditPoint(ponto.id);});}if(deleteBtn){deleteBtn.addEventListener('click',async()=>{try{awaitthis.handleDeletePoint(ponto.id);}catch(error){console.error('Erronoeventodedelete:',error);}});}}/***Manipularediçãodeponto*@param{number}pontoId-IDdoponto*/handleEditPoint(pontoId){if(window.mapManager&&typeofwindow.mapManager.editarPonto==='function'){window.mapManager.editarPonto(pontoId);}}/***Manipularremoçãodeponto*@param{number}pontoId-IDdoponto*/asynchandleDeletePoint(pontoId){if(window.mapManager&&typeofwindow.mapManager.removerPonto==='function'){try{awaitwindow.mapManager.removerPonto(pontoId);this.hide();//Fecharpainelapósremoção}catch(error){console.error('Erroaoremoverponto:',error);alert('Erroaoremoverponto.Tentenovamente.');}}}/***Verificarseopainelestávisível*@returns{boolean}*/isOpen(){returnthis.isVisible;}/***Obterpontoatual*@returns{Object|null}*/getCurrentPoint(){returnthis.currentPoint;}}//Instanciarglobalmentewindow.infoPanelManager=newInfoPanelManager();