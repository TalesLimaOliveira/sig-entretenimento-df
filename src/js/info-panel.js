/***GerenciadordoPainelLateraldeInforma√ß√µes-CleanArchitecture**Responsabilidades:*-Exibirinforma√ß√µesdospontosselecionados*-Controlarabertura/fechamentodopainel*-Renderizarconte√∫dodeformaestruturada*-Gerenciareventosdeintera√ß√£o**@authorTalesOliveira(github.com/TalesLimaOliveira)*@version1.0.0*@noteEstearquivocont√©mtrechosdec√≥digogeradoscomaux√≠liodeIntelig√™nciaArtificial.*/classInfoPanelManager{constructor(){this.panel=null;this.panelBody=null;this.panelTitle=null;this.panelImage=null;this.imagePlaceholder=null;this.closeButton=null;this.tabs=null;this.tabContents=null;this.currentTab='overview';this.isVisible=false;this.currentPoint=null;this.init();}/***Inicializaogerenciadordopainel*/init(){console.log('InicializandoInfoPanelManager...');this.setupElements();this.setupEventListeners();console.log('InfoPanelManagerinicializado');}/***ConfigurarelementosDOM*/setupElements(){this.panel=document.getElementById('info-panel');this.panelBody=document.getElementById('info-panel-body');this.panelTitle=document.getElementById('info-panel-title');this.panelImage=document.getElementById('info-panel-image');this.imagePlaceholder=document.querySelector('.info-panel-image-placeholder');this.closeButton=document.getElementById('info-panel-close');this.tabs=document.querySelectorAll('.info-panel-tab');this.tabContents=document.querySelectorAll('.info-panel-tab-content');if(!this.panel||!this.panelBody||!this.panelTitle||!this.closeButton){console.error('Elementosdopaineln√£oencontrados');return;}}/***Configurareventlisteners*/setupEventListeners(){if(!this.closeButton)return;//Bot√£odefecharthis.closeButton.addEventListener('click',()=>{this.hide();});//Eventosdasabasthis.tabs.forEach(tab=>{tab.addEventListener('click',()=>{consttabName=tab.getAttribute('data-tab');this.switchTab(tabName);});});//FecharcomteclaESCdocument.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.isVisible){//N√£ofecharsehouvermodalabertoconsthasOpenModal=document.querySelector('.modal-backdrop[style*="flex"]')||document.querySelector('.modal-backdrop[style*="block"]');if(!hasOpenModal){this.hide();}}});//Fecharaoclicarforadopainel(nomapa)document.addEventListener('click',(e)=>{if(this.isVisible&&!this.panel.contains(e.target)&&!e.target.closest('.marcador-otimizado')&&!e.target.closest('.modal-backdrop')&&!e.target.closest('.login-modal')&&!e.target.closest('.leaflet-popup')&&!e.target.closest('.leaflet-marker-icon')&&!e.target.closest('.custom-marker')){//AdicionardelayparaevitarfechamentoimediatodurantecliquesemmarcadoressetTimeout(()=>{if(this.isVisible){this.hide();}},100);}});}/***Alternarentreabas*@param{string}tabName-Nomedaaba*/switchTab(tabName){//Atualizarestadodaabaatualthis.currentTab=tabName;//Removerclasseactivedetodasasabaseconte√∫dosthis.tabs.forEach(tab=>tab.classList.remove('active'));this.tabContents.forEach(content=>content.classList.remove('active'));//Adicionarclasseactivenaabaeconte√∫doselecionadosconstactiveTab=document.querySelector(`[data-tab="${tabName}"]`);constactiveContent=document.getElementById(`tab-${tabName}`);if(activeTab)activeTab.classList.add('active');if(activeContent)activeContent.classList.add('active');console.log(`Abaalteradapara:${tabName}`);}/***Exibirpainelcominforma√ß√µesdoponto*@param{Object}ponto-Dadosdoponto*/show(ponto){if(!this.panel||!ponto)return;//EvitarqueeventosdecliqueinterfiramduranteaaberturaconstpreventClick=(e)=>{e.stopPropagation();e.preventDefault();};//Adicionarlistenertempor√°rioparaprevenirinterfer√™nciadocument.addEventListener('click',preventClick,{once:true,capture:true});this.currentPoint=ponto;this.renderContent(ponto);this.setupImage(ponto);//GarantirqueaabaOverviewest√°selecionadathis.switchTab('overview');//Adicionarclasseaobodyparaajustarlayoutdocument.body.classList.add('body-with-info-panel');//Mostrarpainelcomtransi√ß√£osuavethis.panel.classList.remove('hidden');//UsarrequestAnimationFrameparagarantirqueatransi√ß√£oocorrarequestAnimationFrame(()=>{this.panel.classList.add('visible');});this.isVisible=true;console.log('Painelabertopara:',ponto.nome);//Removerolistenerpreventivoap√≥sumbrevedelaysetTimeout(()=>{document.removeEventListener('click',preventClick,{capture:true});},200);}/***Ocultarpainel*/hide(){if(!this.panel||!this.isVisible)return;this.panel.classList.remove('visible');setTimeout(()=>{this.panel.classList.add('hidden');},300);//Removerclassedobodydocument.body.classList.remove('body-with-info-panel');this.isVisible=false;this.currentPoint=null;console.log('Painelfechado');}/***Configurarimagemdopainel*@param{Object}ponto-Dadosdoponto*/setupImage(ponto){if(!this.panelImage||!this.imagePlaceholder)return;//Definirt√≠tulodaimagemthis.panelTitle.textContent=ponto.nome||'Localselecionado';//Verificarseh√°imagemdispon√≠vel(novaestruturaoulegada)letimageUrl=null;letimageDescription='';if(ponto.imagem){if(typeofponto.imagem==='object'&&ponto.imagem.url){//NovaestruturacomobjetodeimagemimageUrl=ponto.imagem.url;imageDescription=ponto.imagem.description||`Imagemde${ponto.nome}`;}elseif(typeofponto.imagem==='string'&&ponto.imagem!=='https://via.placeholder.com/300x200'){//EstruturalegadacomstringimageUrl=ponto.imagem;imageDescription=`Imagemde${ponto.nome}`;}}if(imageUrl){this.panelImage.src=imageUrl;this.panelImage.alt=imageDescription;this.panelImage.title=imageDescription;this.panelImage.style.display='block';this.imagePlaceholder.style.display='none';//Tratamentodeerrodecarregamentodaimagemthis.panelImage.onerror=()=>{console.warn(`Erroaocarregarimagem:${imageUrl}`);this.panelImage.style.display='none';this.imagePlaceholder.style.display='flex';};}else{//Mostrarplaceholderquandon√£oh√°imagemthis.panelImage.style.display='none';this.imagePlaceholder.style.display='flex';}}/***Renderizarconte√∫dodopainel*@param{Object}ponto-Dadosdoponto*/renderContent(ponto){if(!this.panelBody)return;constcategoria=window.databaseManager?.obterCategoria(ponto.categoria);constisAdmin=window.authManager?.isAdmin();constuser=window.authManager?.getCurrentUser();//Renderizarapenasoconte√∫dodaabaOverviewthis.panelBody.innerHTML=`<divclass="info-details">${this.renderBasicInfo(ponto)}${this.renderContactInfo(ponto)}${this.renderAdditionalInfo(ponto)}${this.renderTags(ponto)}${this.renderUserActions(ponto,user)}${isAdmin?this.renderAdminActions(ponto):''}</div>`;//Configurareventosdosbot√µesthis.setupActionButtons(ponto,user);if(isAdmin){this.setupAdminButtons(ponto);}}/***Renderizara√ß√µesdousu√°rio(favoritar,sugerirmudan√ßa)*/renderUserActions(ponto,user){if(!ponto)return'';constisAuthenticated=window.authManager?.isAuthenticated();//!TODO:Implementarsistemadefavoritos//constisFavorito=isAuthenticated&&user?//window.databaseManager?.isFavorito(ponto.id,user.username):false;constisFavorito=false;//Temporariamentesemprefalsereturn`<divclass="info-user-actions"><divclass="action-buttons-top"><buttonclass="action-btnfavorite-btn"id="btn-favorite"data-ponto-id="${ponto.id}"title="Funcionalidadeemdesenvolvimento"><iclass="fasfa-heart"></i>Favoritar</button><buttonclass="action-btnroutes-btn"id="btn-routes"data-ponto-id="${ponto.id}"disabled><iclass="fasfa-route"></i>Rotas</button></div><divclass="action-buttons-bottom"><buttonclass="action-btnsuggest-btn"id="btn-suggest"data-ponto-id="${ponto.id}"><iclass="fasfa-edit"></i>Sugerirmudan√ßa</button></div></div>`;}/***Configurareventosdosbot√µesdea√ß√£o*/setupActionButtons(ponto,user){//Bot√£odefavoritarconstfavoriteBtn=document.getElementById('btn-favorite');if(favoriteBtn){favoriteBtn.addEventListener('click',(e)=>{e.preventDefault();this.handleFavoriteClick(ponto);});}//Bot√£oderotas(n√£ofuncional)constroutesBtn=document.getElementById('btn-routes');if(routesBtn){routesBtn.addEventListener('click',(e)=>{e.preventDefault();this.showNotification('Funcionalidadederotasemdesenvolvimento','info');});}//Bot√£odesugerirmudan√ßaconstsuggestBtn=document.getElementById('btn-suggest');if(suggestBtn){suggestBtn.addEventListener('click',(e)=>{e.preventDefault();this.handleSuggestClick(ponto);});}}/***Handlecliquenobot√£odefavoritar*/handleFavoriteClick(ponto){//!TODO:Implementarsistemadefavoritosconsole.log('!TODO:Implementarsistemadefavoritos');//Mostrarnotifica√ß√£odedesenvolvimentothis.showNotification('Emdesenvolvimento','info');return;}/***Handlecliquenobot√£odesugerirmudan√ßa*/handleSuggestClick(ponto){//Verifica√ß√£oseguradeautentica√ß√£oif(!window.authManager||!window.authManager.isAuthenticated()){console.log('InfoPanel:Usu√°rion√£oautenticado-abrindomodaldelogin');if(!window.loginModal){console.error('InfoPanel:Modaldeloginn√£odispon√≠vel');this.showNotification('Sistemadeloginn√£odispon√≠vel.Recarregueap√°gina.','error');return;}window.loginModal.open({pendingAction:()=>this.handleSuggestClick(ponto)});return;}//Abrirmodaldeformul√°riocomdadospr√©-preenchidosthis.openSuggestionFormModal(ponto);}/***Abrirmodaldeformul√°riocomdadospr√©-preenchidosparasugest√£o*/openSuggestionFormModal(ponto){try{//Verificarseomodaldeadicionarpontoexisteif(!window.addPointModal){console.error('Modaldeadicionarponton√£oencontrado');this.showNotification('Erro:Modaln√£odispon√≠vel','error');return;}//Abriromodalcomosdadosdopontoatualwindow.addPointModal.open({isEditMode:true,isSuggestion:true,pointData:{id:ponto.id,nome:ponto.nome||'',categoria:ponto.categoria||'geral',descricao:ponto.descricao||'',endereco:ponto.endereco||'',telefone:ponto.telefone||'',website:ponto.website||'',horario:ponto.horario||'',preco:ponto.preco||'',imagem:ponto.imagem||'',coordenadas:ponto.coordenadas||[ponto.lat,ponto.lng]},originalPoint:ponto,onSave:(dadosAtualizados)=>{this.processarSugestao(ponto,dadosAtualizados);}});console.log('Modaldesugest√£oabertopara:',ponto.nome);}catch(error){console.error('Erroaoabrirmodaldesugest√£o:',error);this.showNotification('Erroaoabrirformul√°riodesugest√£o','error');}}/***Processarsugest√£oenviadapeloformul√°rio*/processarSugestao(pontoOriginal,dadosAtualizados){try{constuser=window.authManager.getCurrentUser();if(!user){this.showNotification('Erro:Usu√°rion√£oautenticado','error');return;}//Identificarquaiscamposforamalteradosconstsugestoes={};constcamposParaComparar=['nome','categoria','descricao','endereco','telefone','website','horario','preco','imagem'];for(constcampoofcamposParaComparar){constvalorOriginal=pontoOriginal[campo]||'';constvalorNovo=dadosAtualizados[campo]||'';if(valorNovo!==valorOriginal&&valorNovo.trim()!==''){sugestoes[campo]=valorNovo.trim();}}//Verificarcoordenadasif(dadosAtualizados.coordenadas&&(dadosAtualizados.coordenadas[0]!==pontoOriginal.lat||dadosAtualizados.coordenadas[1]!==pontoOriginal.lng)){sugestoes.coordenadas=dadosAtualizados.coordenadas;}//Verificarseh√°algumasugest√£oif(Object.keys(sugestoes).length===0){this.showNotification('Nenhumaaltera√ß√£odetectada','info');return;}//Enviarsugest√£owindow.databaseManager.sugerirMudanca(pontoOriginal.id,sugestoes,user.username);this.showNotification('Sugest√£oenviadaparaan√°lise!','success');console.log('Sugest√£oprocessada:',sugestoes);}catch(error){console.error('Erroaoprocessarsugest√£o:',error);this.showNotification('Erroaoenviarsugest√£o','error');}}/***Mostrarnotifica√ß√£o*/showNotification(message,type='info'){//Sistemadethrottlingparareduzirnotifica√ß√µesrepetidasif(!this.notificationThrottle){this.notificationThrottle=newMap();}constthrottleKey=`${type}-${message}`;constnow=Date.now();constlastShown=this.notificationThrottle.get(throttleKey);//Paraerros,s√≥mostrarsepassoupelomenos5segundos//Paraoutrostipos,2segundosconstthrottleTime=type==='error'?5000:2000;if(lastShown&&(now-lastShown)<throttleTime){console.log(`Notifica√ß√£othrottled:${message}`);return;}this.notificationThrottle.set(throttleKey,now);//Usarosistemadenotifica√ß√µesglobalsedispon√≠velif(window.notificationSystem){window.notificationSystem.show(message,type);return;}//Fallbackparaimplementa√ß√£osimplesthis.showSimpleNotification(message,type);}/***Implementa√ß√£osimplesdenotifica√ß√£ocomofallback*/showSimpleNotification(message,type){//Limitarn√∫merodenotifica√ß√µessimult√¢neasconstexistingNotifications=document.querySelectorAll('.notification.show');if(existingNotifications.length>=3){//Removeramaisantigaconstoldest=existingNotifications[0];oldest.style.transform='translateX(100%)';setTimeout(()=>{if(oldest.parentNode){oldest.parentNode.removeChild(oldest);}},300);}constcolors={success:'#10b981',error:'#ef4444',info:'#3b82f6',warning:'#f59e0b'};constnotification=document.createElement('div');notification.className=`notification${type}show`;notification.innerHTML=`<divstyle="display:flex;align-items:center;gap:0.5rem;"><iclass="fasfa-${this.getNotificationIcon(type)}"></i><span>${message}</span></div>`;//Reduzirtamanhodasnotifica√ß√µesdeerroconstfontSize=type==='error'?'0.85rem':'0.9rem';constpadding=type==='error'?'0.75rem':'1rem';notification.style.cssText=`position:fixed;top:${20+(existingNotifications.length*70)}px;right:20px;background:${colors[type]||colors.info};color:white;padding:${padding};border-radius:6px;z-index:10001;max-width:280px;font-size:${fontSize};transform:translateX(100%);transition:transform0.3sease;box-shadow:04px12pxrgba(0,0,0,0.15);`;document.body.appendChild(notification);//Mostrarnotifica√ß√£orequestAnimationFrame(()=>{notification.style.transform='translateX(0)';});//Tempobaseadonotipo:errosdurammenosconstduration=type==='error'?3000:4000;//Removerap√≥sotempoespecificadosetTimeout(()=>{notification.style.transform='translateX(100%)';setTimeout(()=>{if(notification.parentNode){document.body.removeChild(notification);}},300);},duration);}/***Obter√≠coneparanotifica√ß√£o*/getNotificationIcon(type){consticons={success:'check-circle',error:'exclamation-circle',info:'info-circle',warning:'exclamation-triangle'};returnicons[type]||icons.info;}/***Renderizarinforma√ß√µesb√°sicas*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinforma√ß√µesb√°sicas*/renderBasicInfo(ponto){lethtml='';if(ponto.endereco){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üìç</span><spanclass="info-detail-text">${ponto.endereco}</span></div>`;}if(ponto.descricao){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üìù</span><spanclass="info-detail-text">${ponto.descricao}</span></div>`;}returnhtml;}/***Renderizarinforma√ß√µesdecontato*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinforma√ß√µesdecontato*/renderContactInfo(ponto){lethtml='';if(ponto.telefone){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üìû</span><spanclass="info-detail-text"><ahref="tel:${ponto.telefone}"class="info-link">${ponto.telefone}</a></span></div>`;}if(ponto.website){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üåê</span><spanclass="info-detail-text"><ahref="${ponto.website}"target="_blank"class="info-link">Siteoficial</a></span></div>`;}returnhtml;}/***Renderizarinforma√ß√µesadicionais*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasinforma√ß√µesadicionais*/renderAdditionalInfo(ponto){lethtml='';if(ponto.horario){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üïí</span><spanclass="info-detail-text">${ponto.horario}</span></div>`;}if(ponto.preco){html+=`<divclass="info-detail"><spanclass="info-detail-icon">üí∞</span><spanclass="info-detail-text">${ponto.preco}</span></div>`;}if(ponto.avaliacao>0){html+=`<divclass="info-detail"><spanclass="info-detail-icon"></span><spanclass="info-detail-text">${ponto.avaliacao}/5</span></div>`;}returnhtml;}/***Renderizartags*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdastags*/renderTags(ponto){if(!ponto.tags||!Array.isArray(ponto.tags)||ponto.tags.length===0){return'';}consttagsHtml=ponto.tags.map(tag=>`<spanclass="info-tag">#${tag}</span>`).join('');return`<divclass="info-tags">${tagsHtml}</div>`;}/***Renderizara√ß√µesdeadministrador*@param{Object}ponto-Dadosdoponto*@returns{string}HTMLdasa√ß√µesdeadmin*/renderAdminActions(ponto){return`<divclass="info-admin-actions"><buttonclass="info-admin-btnedit"data-action="edit"data-id="${ponto.id}"><iclass="fasfa-edit"></i>Editar</button><buttonclass="info-admin-btndelete"data-action="delete"data-id="${ponto.id}"><iclass="fasfa-trash"></i>Remover</button></div>`;}/***Obter√≠conedacategoria*@param{Object}categoria-Dadosdacategoria*@returns{string}Emojido√≠cone*/getIconeCategoria(categoria){if(!categoria)return'üìç';constmapaIcones={'cultura':'üé≠','gastronomia':'üç¥','noturno':'üç∫','esportes':'','geral':'üìç','teatro':'üé≠','museu':'üèõ','parque':'üå≥','restaurante':'üçΩ','bar':'üçª','clube':'üéµ','academia':'üèã','shopping':'üõç'};returnmapaIcones[categoria.id]||mapaIcones[categoria.nome?.toLowerCase()]||'üìç';}/***Configurarbot√µesdeadministrador*@param{Object}ponto-Dadosdoponto*/setupAdminButtons(ponto){consteditBtn=this.panelBody.querySelector('[data-action="edit"]');constdeleteBtn=this.panelBody.querySelector('[data-action="delete"]');if(editBtn){editBtn.addEventListener('click',()=>{this.handleEditPoint(ponto.id);});}if(deleteBtn){deleteBtn.addEventListener('click',async()=>{try{awaitthis.handleDeletePoint(ponto.id);}catch(error){console.error('Erronoeventodedelete:',error);}});}}/***Manipularedi√ß√£odeponto*@param{number}pontoId-IDdoponto*/handleEditPoint(pontoId){if(window.mapManager&&typeofwindow.mapManager.editarPonto==='function'){window.mapManager.editarPonto(pontoId);}}/***Manipularremo√ß√£odeponto*@param{number}pontoId-IDdoponto*/asynchandleDeletePoint(pontoId){if(window.mapManager&&typeofwindow.mapManager.removerPonto==='function'){try{awaitwindow.mapManager.removerPonto(pontoId);this.hide();//Fecharpainelap√≥sremo√ß√£o}catch(error){console.error('Erroaoremoverponto:',error);alert('Erroaoremoverponto.Tentenovamente.');}}}/***Verificarseopainelest√°vis√≠vel*@returns{boolean}*/isOpen(){returnthis.isVisible;}/***Obterpontoatual*@returns{Object|null}*/getCurrentPoint(){returnthis.currentPoint;}}//Instanciarglobalmentewindow.infoPanelManager=newInfoPanelManager();