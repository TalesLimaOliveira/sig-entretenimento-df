<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontos de Entretenimento DF</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff69b4%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>üé≠</text></svg>" type="image/svg+xml">
    
    <!-- CSS - Layout Responsivo Otimizado -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="src/css/colors.css">
    <link rel="stylesheet" href="src/css/main.css">
    <link rel="stylesheet" href="src/css/components.css">
    <link rel="stylesheet" href="src/css/map-optimizations.css">
    
    <!-- Meta -->
    <meta name="description" content="Mapa interativo responsivo com pontos de entretenimento do Distrito Federal">
    <meta name="keywords" content="DF, entretenimento, mapa, pontos tur√≠sticos, responsivo">
</head>
<body class="theme-dark">
    <!-- Loading -->
    <div class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Carregando Mapa...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <!-- Navigation Buttons -->
                <nav class="header-navigation">
                    <div class="nav-buttons-container" id="nav-buttons-container">
                        <!-- Categorias ser√£o geradas dinamicamente pelo JavaScript -->
                    </div>
                </nav>
                
                <div class="header-actions">
                    <!-- Desktop Actions -->
                    <div class="desktop-actions">
                        <!-- Login Button -->
                        <button class="header-login-btn desktop" id="desktop-login-btn">
                            <i class="fas fa-user"></i>
                            <span class="login-btn-text">ENTRAR</span>
                        </button>
                    </div>
                    
                    <!-- Mobile Actions - sempre vis√≠veis em mobile/tablet -->
                    <div class="mobile-actions">
                        <!-- Login Button Mobile -->
                        <button class="header-login-btn mobile" id="mobile-login-btn">
                            <i class="fas fa-user"></i>
                            <span class="login-btn-text">ENTRAR</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Painel Lateral de Informa√ß√µes -->
            <div id="info-panel" class="info-panel hidden">
                <!-- Header do Painel com Imagem e Nome -->
                <div class="info-panel-header">
                    <div class="info-panel-image-container">
                        <img id="info-panel-image" class="info-panel-image" src="" alt="Imagem do local">
                        <div class="info-panel-image-placeholder">
                            <i class="fas fa-image"></i>
                            <span>Sem imagem dispon√≠vel</span>
                        </div>
                    </div>
                    <div class="info-panel-title-container">
                        <h2 id="info-panel-title">Nome do Local</h2>
                    </div>
                    <button id="info-panel-close" class="info-panel-close" aria-label="Fechar painel">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Abas do Painel -->
                <div class="info-panel-tabs">
                    <button class="info-panel-tab active" data-tab="overview">
                        <i class="fas fa-info-circle"></i>
                        Vis√£o Geral
                    </button>
                    <button class="info-panel-tab" data-tab="reviews">
                        <i class="fas fa-star"></i>
                        Avalia√ß√£o
                    </button>
                </div>

                <!-- Conte√∫do das Abas -->
                <div class="info-panel-content">
                    <!-- Aba: Vis√£o Geral -->
                    <div id="tab-overview" class="info-panel-tab-content active">
                        <!-- Informa√ß√µes do Local -->
                        <div class="info-panel-details">
                            <div id="info-panel-body">
                                <!-- Conte√∫do ser√° inserido dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Avalia√ß√£o -->
                    <div id="tab-reviews" class="info-panel-tab-content">
                        <div class="info-panel-placeholder">
                            <i class="fas fa-comments"></i>
                            <h3>Coment√°rios e Avalia√ß√µes</h3>
                            <p>Esta funcionalidade estar√° dispon√≠vel em breve.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="src/js/database.js"></script>
    <script src="src/js/auth.js"></script>
    <script src="src/js/info-panel.js"></script>
    <script src="src/js/map.js"></script>
    <script src="src/js/theme-colors.js"></script>
    <script src="src/components/modal.js"></script>
    <script src="src/components/login-modal.js"></script>
    <script src="src/components/register-modal.js"></script>
    <script src="src/components/user-menu.js"></script>
    <script src="src/components/dynamic-user-button.js"></script>
    <script src="src/components/add-point-modal.js"></script>
    <script src="src/components/error-handler.js"></script>
    <script src="src/js/app.js"></script>
    
    <!-- Initialize -->
    <script>
        // Sistema de inicializa√ß√£o robusto
        class AppInitializer {
            constructor() {
                this.managers = {};
                this.errors = [];
                this.initialized = false;
            }
            
            async init() {
                console.log('Iniciando sistema de inicializa√ß√£o...');
                
                try {
                    await this.waitForDOM();
                    await this.checkDependencies();
                    await this.waitForManagers();
                    await this.initializeApp();
                    
                    console.log('Sistema inicializado com sucesso!');
                    this.initialized = true;
                    
                } catch (error) {
                    console.error('Erro cr√≠tico na inicializa√ß√£o:', error);
                    this.showError(error);
                }
            }
            
            async waitForDOM() {
                if (document.readyState === 'loading') {
                    await new Promise(resolve => {
                        document.addEventListener('DOMContentLoaded', resolve);
                    });
                }
                console.log('DOM ready');
            }
            
            async checkDependencies() {
                console.log('ÔøΩ Verificando depend√™ncias...');
                
                // Verificar Leaflet
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet n√£o foi carregado');
                }
                
                // Verificar elemento do mapa
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    throw new Error('Elemento do mapa n√£o encontrado');
                }
                
                console.log('Depend√™ncias verificadas');
            }
            
            async waitForManagers() {
                console.log('Aguardando managers serem carregados...');
                
                const managersToCheck = [
                    { name: 'databaseManager', critical: true },
                    { name: 'authManager', critical: false },
                    { name: 'loginModal', critical: false },
                    { name: 'registerModal', critical: false },
                    { name: 'modalManager', critical: false },
                    { name: 'themeManager', critical: false },
                    { name: 'mapManager', critical: true }
                ];
                
                // Aguardar um pouco para os scripts carregarem
                await new Promise(resolve => setTimeout(resolve, 200));
                
                for (const manager of managersToCheck) {
                    const maxAttempts = 50; // 5 segundos m√°ximo
                    let attempts = 0;
                    
                    while (!window[manager.name] && attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (window[manager.name]) {
                        console.log(`${manager.name} loaded`);
                        
                        // Inicializar o databaseManager se necess√°rio
                        if (manager.name === 'databaseManager' && window.databaseManager.init) {
                            console.log('Initializing databaseManager...');
                            try {
                                await window.databaseManager.init();
                                console.log('DatabaseManager initialized successfully');
                                
                                // Verificar se pontos foram carregados
                                const pontos = window.databaseManager.getPontos();
                                console.log(`Points loaded: ${pontos.length}`);
                                
                                if (pontos.length === 0) {
                                    console.warn('No points loaded, forcing default data...');
                                    // For√ßar uso de dados padr√£o
                                    window.databaseManager.confirmedPoints = window.databaseManager.getConfirmedPointsDefault();
                                    window.databaseManager.categorias = window.databaseManager.getCategoriesDefault();
                                    
                                    // Salvar no localStorage para pr√≥ximas sess√µes
                                    window.databaseManager.salvarTodosDados();
                                    
                                    console.log(`Default data forced: ${window.databaseManager.confirmedPoints.length} points`);
                                }
                                
                                // Verificar categorias tamb√©m
                                const categorias = window.databaseManager.getCategorias();
                                if (!categorias || categorias.length === 0) {
                                    console.warn('No categories loaded, forcing default categories...');
                                    window.databaseManager.categorias = window.databaseManager.getCategoriesDefault();
                                    window.databaseManager.salvarCategorias();
                                }
                                
                            } catch (error) {
                                console.error('Error initializing DatabaseManager:', error);
                                
                                // Para protocolo file://, tentar inicializa√ß√£o com dados padr√£o
                                if (window.location.protocol === 'file:') {
                                    console.log('Attempting initialization with default data for file://...');
                                    try {
                                        // Garantir que categorias padr√£o estejam dispon√≠veis
                                        window.databaseManager.categorias = window.databaseManager.getCategoriesDefault();
                                        window.databaseManager.confirmedPoints = window.databaseManager.getConfirmedPointsDefault();
                                        window.databaseManager.usuarios = window.databaseManager.getUsersDefault().reduce((acc, user) => {
                                            acc[user.username] = user;
                                            return acc;
                                        }, {});
                                        console.log('Default data loaded for file://');
                                    } catch (fallbackError) {
                                        console.error('Fallback failed:', fallbackError);
                                        if (manager.critical) {
                                            throw new Error(`Falha cr√≠tica na inicializa√ß√£o do DatabaseManager: ${error.message}`);
                                        }
                                    }
                                } else if (manager.critical) {
                                    throw new Error(`Falha cr√≠tica na inicializa√ß√£o do DatabaseManager: ${error.message}`);
                                }
                            }
                        }
                        
                        // Inicializar o mapManager se necess√°rio
                        if (manager.name === 'mapManager' && window.mapManager && window.mapManager.init) {
                            console.log('Initializing mapManager...');
                            try {
                                await window.mapManager.init();
                                console.log('MapManager initialized successfully');
                                
                                // For√ßar carregamento dos pontos ap√≥s inicializa√ß√£o
                                setTimeout(async () => {
                                    if (window.databaseManager && window.databaseManager.getPontos) {
                                        const pontos = window.databaseManager.getPontos();
                                        console.log(`Forcing load of ${pontos.length} points on map...`);
                                        
                                        if (pontos.length > 0) {
                                            window.mapManager._loadPoints(pontos);
                                            console.log('Points loaded on map');
                                        } else {
                                            console.warn('No points available to load on map');
                                        }
                                    }
                                }, 500);
                                
                            } catch (mapError) {
                                console.error('‚ùå Erro ao inicializar MapManager:', mapError);
                                if (manager.critical) {
                                    throw new Error(`Falha cr√≠tica na inicializa√ß√£o do MapManager: ${mapError.message}`);
                                }
                            }
                        }
                        
                        this.managers[manager.name] = window[manager.name];
                    } else {
                        const error = `${manager.name} n√£o foi carregado`;
                        console.error(`‚ùå ${error}`);
                        
                        if (manager.critical) {
                            throw new Error(`Manager cr√≠tico falhou: ${error}`);
                        } else {
                            this.errors.push(error);
                        }
                    }
                }
                
                if (this.errors.length > 0) {
                    console.warn('Alguns managers n√£o cr√≠ticos falharam:', this.errors);
                }
                
                console.log('Managers carregados');
            }
            
            async initializeApp() {
                console.log('Inicializando aplica√ß√£o principal...');
                
                // Aguardar um pouco mais
                await new Promise(resolve => setTimeout(resolve, 100));
                
                window.app = new PontosEntretenimentoApp();
                
                // CR√çTICO: Chamar o m√©todo init() da aplica√ß√£o
                await window.app.init();
                
                console.log('Aplica√ß√£o inicializada e pronta');
            }
            
            showError(error) {
                console.error('Stack trace:', error.stack);
                
                // Remove loading screen
                const loadingScreen = document.querySelector('.loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                
                // Mostra erro detalhado
                document.body.innerHTML = `
                    <div style="padding: 2rem; max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">
                        <div style="text-align: center; color: #ef4444; margin-bottom: 2rem;">
                            <h1>Erro ao carregar a aplica√ß√£o</h1>
                            <p><strong>Detalhes:</strong> ${error.message}</p>
                        </div>
                        
                        ${this.errors.length > 0 ? `
                            <div style="margin-bottom: 2rem;">
                                <h3>Warnings:</h3>
                                <ul style="color: #f59e0b;">
                                    ${this.errors.map(err => `<li>${err}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <details style="margin: 1rem 0;">
                            <summary style="cursor: pointer; font-weight: bold;">Informa√ß√µes t√©cnicas</summary>
                            <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 12px; margin-top: 1rem;">${error.stack || 'Stack trace n√£o dispon√≠vel'}</pre>
                        </details>
                    </div>
                `;
            }
        }
        
        // Iniciar o sistema
        const initializer = new AppInitializer();
        initializer.init().catch(error => {
            console.error('Erro ao inicializar aplica√ß√£o:', error);
            // Mostrar erro espec√≠fico para o usu√°rio
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) {
                loadingScreen.innerHTML = `
                    <div style="text-align: center; color: red;">
                        <h3>Erro ao carregar aplica√ß√£o</h3>
                        <p>Verifique a conex√£o com a internet e recarregue a p√°gina.</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">
                            Recarregar
                        </button>
                    </div>
                `;
            }
        });
        
        // FUN√á√ÉO DE DEBUG: For√ßar cria√ß√£o dos bot√µes ap√≥s 2 segundos
        setTimeout(() => {
            console.log('üö® DEBUG: For√ßando cria√ß√£o dos bot√µes de categoria...');
            const container = document.getElementById('nav-buttons-container');
            if (container) {
                console.log('DEBUG: Container encontrado, for√ßando bot√µes...');
                container.innerHTML = `
                    <button class="nav-btn active category-btn" data-categoria="todos" title="Todos os pontos" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #3b82f6; border-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-globe"></i>
                        <span class="nav-btn-text">Todos</span>
                    </button>
                    <button class="nav-btn category-btn" data-categoria="geral" title="Geral" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #3b82f6; border-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="nav-btn-text">Geral</span>
                    </button>
                    <button class="nav-btn category-btn" data-categoria="esportes-lazer" title="Esportes e Lazer" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #10b981; border-color: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-futbol"></i>
                        <span class="nav-btn-text">Esportes e Lazer</span>
                    </button>
                    <button class="nav-btn category-btn" data-categoria="gastronomia" title="Gastronomia" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #f59e0b; border-color: #f59e0b; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-utensils"></i>
                        <span class="nav-btn-text">Gastronomia</span>
                    </button>
                    <button class="nav-btn category-btn" data-categoria="geek-nerd" title="Geek/Nerd" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #8b5cf6; border-color: #8b5cf6; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-gamepad"></i>
                        <span class="nav-btn-text">Geek/Nerd</span>
                    </button>
                    <button class="nav-btn category-btn" data-categoria="casas-noturnas" title="Casas Noturnas" 
                            style="display: flex !important; visibility: visible !important; opacity: 1 !important; background: #ef4444; border-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin: 0.2rem;">
                        <i class="fas fa-glass-cheers"></i>
                        <span class="nav-btn-text">Casas Noturnas</span>
                    </button>
                `;
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.gap = '0.5rem';
                container.style.justifyContent = 'center';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                container.style.zIndex = '1000';
                console.log('DEBUG: Bot√µes criados com sucesso!');
            } else {
                console.error('DEBUG: Container n√£o encontrado!');
            }
        }, 2000);
    </script>
</body>
</html>
