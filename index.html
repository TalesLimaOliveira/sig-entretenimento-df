<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontos de Entretenimento DF</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff69b4%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>üé≠</text></svg>" type="image/svg+xml">
    
    <!-- CSS - Layout Responsivo Otimizado -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="src/css/colors.css">
    <link rel="stylesheet" href="src/css/main.css">
    <link rel="stylesheet" href="src/css/components.css">
    <link rel="stylesheet" href="src/css/map-optimizations.css">
    
    <!-- Meta -->
    <meta name="description" content="Mapa interativo responsivo com pontos de entretenimento do Distrito Federal">
    <meta name="keywords" content="DF, entretenimento, mapa, pontos tur√≠sticos, responsivo">
</head>
<body class="theme-dark">
    <!-- Loading -->
    <div class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Carregando Mapa...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <!-- Header Superior: Logo + Nome + Bot√£o Entrar -->
            <div class="header-top">
                <div class="header-logo">
                    <div class="logo-emoji">üé≠</div>
                    <div class="logo-text">
                        <h1>Pontos de Entretenimento DF</h1>
                    </div>
                </div>
                
                <div class="header-actions">
                    <!-- Desktop Actions -->
                    <div class="desktop-actions">
                        <!-- Login Button -->
                        <button class="header-login-btn desktop" id="desktop-login-btn">
                            <i class="fas fa-user"></i>
                            <span class="login-btn-text">ENTRAR</span>
                        </button>
                    </div>
                    
                    <!-- Mobile Actions - sempre vis√≠veis em mobile/tablet -->
                    <div class="mobile-actions">
                        <!-- Login Button Mobile -->
                        <button class="header-login-btn mobile" id="mobile-login-btn">
                            <i class="fas fa-user"></i>
                            <span class="login-btn-text">ENTRAR</span>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </header>

    <!-- Container de Filtros -->
    <div class="filters-container">
        <div class="container">
            <nav class="filters-navigation">
                <div class="nav-buttons-container" id="nav-buttons-container">
                    <!-- Categorias ser√£o geradas dinamicamente pelo JavaScript -->
                </div>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Painel Lateral de Informa√ß√µes -->
            <div id="info-panel" class="info-panel hidden">
                <!-- Header do Painel com Imagem e Nome -->
                <div class="info-panel-header">
                    <div class="info-panel-image-container">
                        <img id="info-panel-image" class="info-panel-image" src="" alt="Imagem do local">
                        <div class="info-panel-image-placeholder">
                            <i class="fas fa-image"></i>
                            <span>Sem imagem dispon√≠vel</span>
                        </div>
                    </div>
                    <div class="info-panel-title-container">
                        <h2 id="info-panel-title">Nome do Local</h2>
                    </div>
                    <button id="info-panel-close" class="info-panel-close" aria-label="Fechar painel">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Abas do Painel -->
                <div class="info-panel-tabs">
                    <button class="info-panel-tab active" data-tab="overview">
                        <i class="fas fa-info-circle"></i>
                        Vis√£o Geral
                    </button>
                    <button class="info-panel-tab" data-tab="reviews">
                        <i class="fas fa-star"></i>
                        Avalia√ß√£o
                    </button>
                </div>

                <!-- Conte√∫do das Abas -->
                <div class="info-panel-content">
                    <!-- Aba: Vis√£o Geral -->
                    <div id="tab-overview" class="info-panel-tab-content active">
                        <!-- Informa√ß√µes do Local -->
                        <div class="info-panel-details">
                            <div id="info-panel-body">
                                <!-- Conte√∫do ser√° inserido dinamicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Avalia√ß√£o -->
                    <div id="tab-reviews" class="info-panel-tab-content">
                        <div class="info-panel-placeholder">
                            <i class="fas fa-comments"></i>
                            <h3>Coment√°rios e Avalia√ß√µes</h3>
                            <p>Esta funcionalidade estar√° dispon√≠vel em breve.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Core Managers - Load First -->
    <script>
        // Pre-initialize core global objects to avoid timing issues
        window.managers = {};
        window.classesLoaded = {};
        console.log('Pre-initializing global manager namespace');
    </script>
    
    <script src="src/js/database.js"></script>
    <script>
        // Mark DatabaseManager as loaded
        if (typeof DatabaseManager !== 'undefined') {
            window.classesLoaded.DatabaseManager = true;
            console.log('DatabaseManager class loaded successfully');
        }
    </script>
    
    <script src="src/js/auth.js"></script>
    <script>
        // Mark AuthManager as loaded
        if (typeof AuthManager !== 'undefined') {
            window.classesLoaded.AuthManager = true;
            console.log('AuthManager class loaded successfully');
        }
    </script>
    
    <script src="src/js/info-panel.js"></script>
    <script>
        // Mark InfoPanelManager as loaded
        if (typeof InfoPanelManager !== 'undefined') {
            window.classesLoaded.InfoPanelManager = true;
            console.log('InfoPanelManager class loaded successfully');
        }
    </script>
    
    <script src="src/js/map.js"></script>
    <script>
        // Mark MapManager as loaded
        if (typeof MapManager !== 'undefined') {
            window.classesLoaded.MapManager = true;
            console.log('MapManager class loaded successfully');
        }
    </script>
    
    <script src="src/js/theme-colors.js"></script>
    
    <!-- Components -->
    <script src="src/components/modal.js"></script>
    <script>
        // Mark ModalManager as loaded
        if (typeof ModalManager !== 'undefined') {
            window.classesLoaded.ModalManager = true;
            console.log('ModalManager class loaded successfully');
        }
    </script>
    
    <script src="src/components/login-modal.js"></script>
    <script>
        // Mark LoginModal as loaded
        if (typeof LoginModal !== 'undefined') {
            window.classesLoaded.LoginModal = true;
            console.log('LoginModal class loaded successfully');
        }
    </script>
    
    <script src="src/components/register-modal.js"></script>
    <script src="src/components/user-menu.js"></script>
    <script src="src/components/dynamic-user-button.js"></script>
    <script src="src/components/add-point-modal.js"></script>
    <script src="src/components/error-handler.js"></script>
    
    <!-- Main Application -->
    <script src="src/js/app.js"></script>
    <script>
        // Mark PontosEntretenimentoApp as loaded
        if (typeof PontosEntretenimentoApp !== 'undefined') {
            window.classesLoaded.PontosEntretenimentoApp = true;
            console.log('PontosEntretenimentoApp class loaded successfully');
        } else {
            console.error('PontosEntretenimentoApp class failed to load!');
        }
        
        // Debug: List all loaded classes
        console.log('Classes loaded check:', window.classesLoaded);
    </script>
    
    <!-- Initialize -->
    <script>
        // Sistema de inicializa√ß√£o simplificado
        class AppInitializer {
            constructor() {
                this.initialized = false;
            }
            
            async init() {
                console.log('Iniciando sistema de inicializa√ß√£o simplificado...');
                
                try {
                    // Aguardar DOM
                    await this.waitForDOM();
                    console.log('DOM ready');
                    
                    // Aguardar Leaflet
                    await this.waitForLeaflet();
                    console.log('Leaflet ready');
                    
                    // Aguardar classes
                    await this.waitForClasses();
                    console.log('Classes ready');
                    
                    // Criar managers
                    await this.createManagers();
                    console.log('Managers created');
                    
                    // Inicializar aplica√ß√£o
                    await this.initializeApp();
                    console.log('App initialized');
                    
                    // Remover loading
                    this.removeLoadingScreen();
                    console.log('Sistema inicializado com sucesso');
                    
                } catch (error) {
                    console.error('Erro na inicializa√ß√£o:', error);
                    this.showError(error);
                }
            }
            
            async waitForDOM() {
                if (document.readyState === 'loading') {
                    await new Promise(resolve => {
                        document.addEventListener('DOMContentLoaded', resolve);
                    });
                }
            }
            
            async waitForLeaflet() {
                const maxWait = 10000;
                const start = Date.now();
                
                while (Date.now() - start < maxWait) {
                    if (typeof L !== 'undefined') {
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                throw new Error('Leaflet n√£o carregou');
            }
            
            async waitForClasses() {
                const maxWait = 10000;
                const start = Date.now();
                
                while (Date.now() - start < maxWait) {
                    if (typeof window.PontosEntretenimentoApp === 'function' &&
                        typeof window.DatabaseManager === 'function') {
                        console.log('Classes principais carregadas');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                throw new Error('Classes n√£o carregaram: PontosEntretenimentoApp=' + typeof window.PontosEntretenimentoApp + ', DatabaseManager=' + typeof window.DatabaseManager);
            }
            
            async createManagers() {
                // Criar DatabaseManager
                if (!window.databaseManager) {
                    window.databaseManager = new window.DatabaseManager();
                    console.log('DatabaseManager criado');
                }
                
                // Criar AuthManager se dispon√≠vel
                if (typeof window.AuthManager === 'function' && !window.authManager) {
                    window.authManager = new window.AuthManager();
                    console.log('AuthManager criado');
                }
                
                // Criar MapManager se dispon√≠vel
                if (typeof window.MapManager === 'function' && !window.mapManager) {
                    window.mapManager = new window.MapManager();
                    console.log('MapManager criado');
                }
            }
            
            async initializeApp() {
                console.log('Inicializando aplica√ß√£o principal...');
                
                // Inicializar DatabaseManager primeiro
                if (window.databaseManager && typeof window.databaseManager.init === 'function') {
                    try {
                        await window.databaseManager.init();
                        console.log('DatabaseManager inicializado');
                    } catch (error) {
                        console.warn('Erro no DatabaseManager, usando fallback:', error);
                        // Para protocolo file://, usar dados padr√£o
                        if (window.location.protocol === 'file:') {
                            window.databaseManager.categorias = window.databaseManager.getCategoriesDefault();
                            window.databaseManager.confirmedPoints = window.databaseManager.getConfirmedPointsDefault();
                            window.databaseManager.pendingPoints = [];
                            window.databaseManager.hiddenPoints = [];
                            window.databaseManager.usuarios = {};
                        } else {
                            throw error;
                        }
                    }
                }
                
                // Inicializar MapManager
                if (window.mapManager && typeof window.mapManager.init === 'function') {
                    try {
                        await window.mapManager.init();
                        console.log('MapManager inicializado');
                    } catch (error) {
                        console.warn('Erro no MapManager:', error);
                    }
                }
                
                // Criar e inicializar aplica√ß√£o principal
                window.app = new window.PontosEntretenimentoApp();
                await window.app.init();
                console.log('PontosEntretenimentoApp inicializado');
            }
            
            removeLoadingScreen() {
                const loading = document.querySelector('.loading-screen');
                if (loading) {
                    loading.style.transition = 'opacity 0.5s ease';
                    loading.style.opacity = '0';
                    setTimeout(() => {
                        if (loading.parentNode) {
                            loading.remove();
                        }
                    }, 500);
                }
            }
            
            showError(error) {
                console.error('Erro de inicializa√ß√£o:', error);
                this.removeLoadingScreen();
                
                document.body.innerHTML = `
                    <div style="padding: 2rem; max-width: 800px; margin: 0 auto; font-family: Arial, sans-serif;">
                        <div style="text-align: center; color: #dc2626; margin-bottom: 2rem;">
                            <h1>Erro ao carregar a aplica√ß√£o</h1>
                            <p><strong>Detalhes:</strong> ${error.message}</p>
                            <button onclick="location.reload()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 1rem;">
                                Recarregar P√°gina
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Inicializar
        console.log('Iniciando inicializa√ß√£o...');
        const initializer = new AppInitializer();
        initializer.init();
    </script>
        
        // Debug listeners
        document.addEventListener('click', (e) => {
            if (e.target.closest('.header-login-btn')) {
                console.log('Login button clicked:', e.target);
            }
            if (e.target.closest('.nav-btn')) {
                console.log('Category button clicked:', e.target.dataset.categoria);
            }
        }, true);
        
        // Configura√ß√£o adicional ap√≥s delay
        setTimeout(() => {
            if (window.app && typeof window.app.configureCategoryMenu === 'function') {
                console.log('Running delayed configuration...');
                window.app.configureCategoryMenu();
                window.app.ensureLoginButtonsWork && window.app.ensureLoginButtonsWork();
            }
        }, 3000);
    </script>
</body>
</html>
