<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Login</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-buttons { margin: 20px 0; }
        .test-buttons button { margin: 10px; padding: 10px 20px; }
        .status { margin: 20px 0; padding: 10px; background: #f0f0f0; }
        .header-login-btn, .user-info { 
            padding: 10px; 
            margin: 10px; 
            border: 1px solid #ccc; 
            cursor: pointer;
        }
        .user-dropdown-menu { 
            display: none; 
            border: 1px solid #ccc; 
            background: white; 
            padding: 10px; 
        }
        .dropdown-item { 
            display: block; 
            padding: 5px; 
            margin: 5px 0; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>Teste de Login - SIG Entretenimento DF</h1>
    
    <div class="status" id="status">Carregando...</div>
    
    <div class="test-buttons">
        <button onclick="testLogin('admin', 'admin')">Login Admin</button>
        <button onclick="testLogin('user', 'user')">Login User</button>
        <button onclick="testLogout()">Logout</button>
        <button onclick="checkStatus()">Verificar Status</button>
    </div>
    
    <div>
        <h3>Simulação dos botões do header:</h3>
        <div class="desktop-actions">
            <button class="header-login-btn desktop" id="desktop-login-btn">
                <i class="fas fa-user"></i>
                <span class="login-btn-text">ENTRAR</span>
            </button>
        </div>
        
        <div class="mobile-actions">
            <button class="header-login-btn mobile" id="mobile-login-btn">
                <i class="fas fa-user"></i>
                <span class="login-btn-text">ENTRAR</span>
            </button>
        </div>
    </div>
    
    <!-- Load FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Load Scripts -->
    <script src="src/js/auth.js"></script>
    <script>
        let testApp = {
            configureLoggedUser: function(user) {
                console.log('TEST: configureLoggedUser chamado para:', user);
                this.updateLoginButton(user);
            },
            
            updateLoginButton: function(user) {
                console.log('TEST: updateLoginButton chamado para:', user.nome);
                
                const isAdmin = user.role === 'administrator';
                const userName = user.nome || user.username || 'Usuário';
                
                // Encontrar containers
                const desktopContainer = document.querySelector('.desktop-actions');
                const mobileContainer = document.querySelector('.mobile-actions');
                
                [desktopContainer, mobileContainer].forEach((container, index) => {
                    if (container) {
                        const containerType = index === 0 ? 'desktop' : 'mobile';
                        
                        // Remover elementos existentes
                        const existingElements = container.querySelectorAll('.header-login-btn, .user-dropdown, .user-info, [id*="login-btn"], [id*="user-info"]');
                        existingElements.forEach(el => el.remove());
                        
                        // Criar novo elemento de menu de usuário
                        const userMenuHTML = `
                            <div class="user-dropdown" id="${containerType}-user-dropdown">
                                <button class="user-info ${isAdmin ? 'is-admin' : ''}" id="${containerType}-user-info-btn">
                                    <div class="user-avatar">
                                        <i class="fas fa-user user-icon"></i>
                                    </div>
                                    <span class="user-name">${userName}</span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </button>
                                <div class="user-dropdown-menu" id="${containerType}-user-info-btn-menu" style="display: none;">
                                    ${isAdmin ? `
                                        <a href="admin.html" class="dropdown-item admin-item">
                                            <i class="fas fa-cogs"></i>
                                            <span>Gerenciar Pontos</span>
                                        </a>
                                    ` : ''}
                                    <button class="dropdown-item logout-btn" data-action="logout">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.insertAdjacentHTML('beforeend', userMenuHTML);
                        console.log(`TEST: Menu de usuário criado para ${containerType}`);
                    }
                });
                
                this.configureUserMenu();
            },
            
            configureUserMenu: function() {
                console.log('TEST: configureUserMenu chamado');
                
                const desktopUserBtn = document.getElementById('desktop-user-info-btn');
                const mobileUserBtn = document.getElementById('mobile-user-info-btn');
                
                [desktopUserBtn, mobileUserBtn].forEach(userInfoBtn => {
                    if (userInfoBtn) {
                        console.log('TEST: Configurando menu para:', userInfoBtn.id);
                        
                        userInfoBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const menuId = userInfoBtn.id + '-menu';
                            const dropdownMenu = document.getElementById(menuId);
                            
                            if (dropdownMenu) {
                                const isVisible = dropdownMenu.style.display !== 'none';
                                
                                // Fechar todos os outros menus
                                document.querySelectorAll('.user-dropdown-menu').forEach(menu => {
                                    if (menu !== dropdownMenu) {
                                        menu.style.display = 'none';
                                    }
                                });
                                
                                // Toggle do menu atual
                                dropdownMenu.style.display = isVisible ? 'none' : 'block';
                                console.log('TEST: Menu toggled:', !isVisible);
                            }
                        });
                        
                        // Configurar logout
                        const menuId = userInfoBtn.id + '-menu';
                        const dropdownMenu = document.getElementById(menuId);
                        if (dropdownMenu) {
                            const logoutBtn = dropdownMenu.querySelector('.logout-btn');
                            if (logoutBtn) {
                                logoutBtn.addEventListener('click', () => {
                                    console.log('TEST: Logout clicado');
                                    testLogout();
                                });
                            }
                        }
                    }
                });
            }
        };
        
        // Simular o app global
        window.app = testApp;
        
        // Event listener para autenticação
        document.addEventListener('authStateChanged', (e) => {
            console.log('TEST: Event authStateChanged recebido:', e.detail);
            const { type, user } = e.detail;
            
            if (type === 'login') {
                testApp.configureLoggedUser(user);
                updateStatus(`Logado como: ${user.nome} (${user.role})`);
            } else if (type === 'logout') {
                location.reload(); // Simular reload
            }
        });
        
        async function testLogin(username, password) {
            console.log('TEST: Tentando login:', username);
            updateStatus('Fazendo login...');
            
            try {
                const result = await window.authManager.login(username, password);
                console.log('TEST: Resultado do login:', result);
                
                if (result.success) {
                    console.log('TEST: Login bem-sucedido');
                    updateStatus(`Login bem-sucedido: ${result.user.nome}`);
                } else {
                    console.log('TEST: Login falhou:', result.message);
                    updateStatus(`Login falhou: ${result.message}`);
                }
            } catch (error) {
                console.error('TEST: Erro no login:', error);
                updateStatus(`Erro: ${error.message}`);
            }
        }
        
        function testLogout() {
            console.log('TEST: Fazendo logout');
            updateStatus('Fazendo logout...');
            
            if (window.authManager) {
                window.authManager.logout();
                updateStatus('Logout realizado');
                setTimeout(() => location.reload(), 500);
            }
        }
        
        function checkStatus() {
            const isAuth = window.authManager ? window.authManager.isAuthenticated() : false;
            const user = isAuth ? window.authManager.getCurrentUser() : null;
            
            updateStatus(isAuth ? 
                `Autenticado: ${user.nome} (${user.role})` : 
                'Não autenticado'
            );
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('STATUS:', message);
        }
        
        // Verificar status inicial
        setTimeout(() => {
            checkStatus();
        }, 500);
    </script>
</body>
</html>
